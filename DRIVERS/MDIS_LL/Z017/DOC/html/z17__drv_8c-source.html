<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - Z17 MDIS Driver - z17_drv.c Source File</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;"></a>
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">Z17 MDIS Driver &nbsp; </h1>
	<h3>z17_drv.c Source File</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>z17_drv.c</h1><a href="z17__drv_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*********************  P r o g r a m  -  M o d u l e ***********************/</span>
00018  <span class="comment">/*-------------------------------[ History ]--------------------------------</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> * $Log: z17_drv.c,v $</span>
00021 <span class="comment"> * Revision 1.15  2017/05/03 16:52:05  DPfeuffer</span>
00022 <span class="comment"> * new checkin</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> * Revision 1.12  2016/07/13 10:09:33  ts</span>
00025 <span class="comment"> * R: m_open failed on EM10A00 GPIOs with 0x20 address space size.</span>
00026 <span class="comment"> * M: previous default ADDRSPACE_SIZE of 0x100 failed to match, corrected back to 0x20.</span>
00027 <span class="comment"> *    (corrected in next commit)    </span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> * Revision 1.11  2014/11/28 14:17:37  MRoth</span>
00030 <span class="comment"> * R: 1.) no toggle function for GPIOs</span>
00031 <span class="comment"> *    2.) Z127 variant always requested an IRQ even if it had none in Hardware</span>
00032 <span class="comment"> *    3.) no support for MSI(x) - no IRQ should happen during ISR</span>
00033 <span class="comment"> *    4.) GPIO reset at driver exit (m_close) not always wanted</span>
00034 <span class="comment"> *    5.) cosmetics</span>
00035 <span class="comment"> * M: 1.a) added setstats Z17_TOG_PORTS, Z17_TOG_HIGH, Z17_TOG_LOW</span>
00036 <span class="comment"> *      b) added AlarmHandler() for timer</span>
00037 <span class="comment"> *    2.) introduced Z127_NOIRQ variant to inhibit IRQs.</span>
00038 <span class="comment"> *    3.) disable IRQs at the beginning and re-enable at the end of the ISR</span>
00039 <span class="comment"> *    4.) added RESET_OFF descriptor key to init function</span>
00040 <span class="comment"> *    5.) revised code completely</span>
00041 <span class="comment"> *</span>
00042 <span class="comment"> * Revision 1.10  2011/11/16 15:24:31  GLeonhardt</span>
00043 <span class="comment"> * R: 1.) Interrupts for GPIO 4-7 did not work with Z34/Z37 core</span>
00044 <span class="comment"> *        A preprocessor string comparison did not work.</span>
00045 <span class="comment"> *        Driver always compiled as Z127 model with 32 bit registers.</span>
00046 <span class="comment"> * M: 1.) Replace string comparison with driver switch from Makefile.</span>
00047 <span class="comment"> *</span>
00048 <span class="comment"> * Revision 1.9  2011/09/12 13:51:23  GLeonhardt</span>
00049 <span class="comment"> * R: Compiler error, if MWRITE_D32 macro is a compound statement</span>
00050 <span class="comment"> * M: Embed macro in braces</span>
00051 <span class="comment"> *</span>
00052 <span class="comment"> * Revision 1.8  2011/07/27 15:17:49  dpfeuffer</span>
00053 <span class="comment"> * R: IRQ latency test initialization problem</span>
00054 <span class="comment"> * M: IRQ latency test initialization revised</span>
00055 <span class="comment"> *</span>
00056 <span class="comment"> * Revision 1.7  2011/07/08 13:20:09  dpfeuffer</span>
00057 <span class="comment"> * R: IRQ latency test required for 16G215-01 design test</span>
00058 <span class="comment"> * M: IRQ latency test implemented</span>
00059 <span class="comment"> *</span>
00060 <span class="comment"> * Revision 1.6  2009/08/03 16:43:18  MRoth</span>
00061 <span class="comment"> * R: no support for 32 bit Z127_GPIO IP core</span>
00062 <span class="comment"> * M: a) added define Z17_MODEL_Z127</span>
00063 <span class="comment"> *    b) added Z17_MODEL_Z127 section to setstat/getstat functions</span>
00064 <span class="comment"> *</span>
00065 <span class="comment"> * Revision 1.5  2009/07/10 10:15:49  CRuff</span>
00066 <span class="comment"> * R: compiler warnings because of unused variables</span>
00067 <span class="comment"> * M: commented out the unused variables</span>
00068 <span class="comment"> *</span>
00069 <span class="comment"> * Revision 1.4  2009/04/17 10:23:38  MRoth</span>
00070 <span class="comment"> * R: no 64 Bit support</span>
00071 <span class="comment"> * M: changed set/getstat to support 64 Bit</span>
00072 <span class="comment"> *</span>
00073 <span class="comment"> * Revision 1.3  2006/12/20 11:23:21  ufranke</span>
00074 <span class="comment"> * added</span>
00075 <span class="comment"> *  + getstat code Z17_IRQ_LAST_REQUEST</span>
00076 <span class="comment"> *</span>
00077 <span class="comment"> * Revision 1.2  2006/06/01 17:03:12  cs</span>
00078 <span class="comment"> * changed ADDRSPACE_SIZE to 32 (real size is reported by Chameleon BBIS)</span>
00079 <span class="comment"> *</span>
00080 <span class="comment"> * Revision 1.1  2004/06/18 14:29:50  ub</span>
00081 <span class="comment"> * Initial Revision</span>
00082 <span class="comment"> *</span>
00083 <span class="comment"> *---------------------------------------------------------------------------</span>
00084 <span class="comment"> * (c) Copyright 2004 by MEN Mikro Elektronik GmbH, Nuernberg, Germany</span>
00085 <span class="comment"> ****************************************************************************/</span>
00086 
<a name="l00087"></a><a class="code" href="z17__drv_8c.html#a0">00087</a> <span class="preprocessor">#define _NO_LL_HANDLE        </span><span class="comment">/* ll_defs.h: don't define LL_HANDLE struct */</span>
00088 
00089 <span class="comment">/*-----------------------------------------+</span>
00090 <span class="comment">|  INCLUDES                                |</span>
00091 <span class="comment">+-----------------------------------------*/</span>
00092 <span class="preprocessor">#include &lt;MEN/men_typs.h&gt;</span>    <span class="comment">/* system dependent definitions   */</span>
00093 <span class="preprocessor">#include &lt;MEN/maccess.h&gt;</span>     <span class="comment">/* hw access macros and types     */</span>
00094 <span class="preprocessor">#include &lt;MEN/dbg.h&gt;</span>         <span class="comment">/* debug functions                */</span>
00095 <span class="preprocessor">#include &lt;MEN/oss.h&gt;</span>         <span class="comment">/* oss functions                  */</span>
00096 <span class="preprocessor">#include &lt;MEN/desc.h&gt;</span>        <span class="comment">/* descriptor functions           */</span>
00097 <span class="preprocessor">#include &lt;MEN/modcom.h&gt;</span>      <span class="comment">/* ID PROM functions              */</span>
00098 <span class="preprocessor">#include &lt;MEN/mdis_api.h&gt;</span>    <span class="comment">/* MDIS global defs               */</span>
00099 <span class="preprocessor">#include &lt;MEN/mdis_com.h&gt;</span>    <span class="comment">/* MDIS common defs               */</span>
00100 <span class="preprocessor">#include &lt;MEN/mdis_err.h&gt;</span>    <span class="comment">/* MDIS error codes               */</span>
00101 <span class="preprocessor">#include &lt;MEN/ll_defs.h&gt;</span>     <span class="comment">/* low-level driver definitions   */</span>
00102 <span class="preprocessor">#include &lt;MEN/arwen.h&gt;</span>       <span class="comment">/* definitions for Arwen GPIO     */</span>
00103 <span class="preprocessor">#include &lt;MEN/chameleon.h&gt;</span>   <span class="comment">/* chameleon header               */</span>
00104 
00105 <span class="comment">/*-----------------------------------------+</span>
00106 <span class="comment">|  DEFINES                                 |</span>
00107 <span class="comment">+-----------------------------------------*/</span>
00108 <span class="preprocessor">#if (defined(Z127V01) &amp;&amp; defined(MDIS_MA_BB_INFO_PTR))</span>
00109 <span class="preprocessor"></span><span class="preprocessor">    #define Z127_INFO_PTR 1</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00111 <span class="preprocessor"></span>
00112 <span class="comment">/* general defines */</span>
<a name="l00113"></a><a class="code" href="z17__drv_8c.html#a1">00113</a> <span class="preprocessor">#define CH_NUMBER          1          </span>
00114 <span class="preprocessor">#ifdef Z127_NOIRQ</span>
00115 <span class="preprocessor"></span><span class="preprocessor">  #define USE_IRQ            FALSE      </span>
00116 <span class="preprocessor">#else</span>
<a name="l00117"></a><a class="code" href="z17__drv_8c.html#a2">00117</a> <span class="preprocessor"></span><span class="preprocessor">  #define USE_IRQ            TRUE       </span>
00118 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00119 
00120 <span class="preprocessor">#ifdef Z127_INFO_PTR</span>
00121 <span class="preprocessor"></span><span class="preprocessor">    #define ADDRSPACE_COUNT    2          </span>
00122 <span class="preprocessor">    #define ADDRSPACE_SIZE     0x100      </span>
00123 <span class="preprocessor">#else</span>
<a name="l00124"></a><a class="code" href="z17__drv_8c.html#a3">00124</a> <span class="preprocessor"></span><span class="preprocessor">    #define ADDRSPACE_COUNT    1          </span>
<a name="l00125"></a><a class="code" href="z17__drv_8c.html#a4">00125</a> <span class="preprocessor">    #define ADDRSPACE_SIZE     0x20       </span>
00126 <span class="preprocessor">#endif</span>
00127 <span class="preprocessor"></span>
00128 <span class="comment">/* debug defines */</span>
<a name="l00129"></a><a class="code" href="z17__drv_8c.html#a5">00129</a> <span class="preprocessor">#define DBG_MYLEVEL        llHdl-&gt;dbgLevel    </span>
<a name="l00130"></a><a class="code" href="z17__drv_8c.html#a6">00130</a> <span class="preprocessor">#define DBH                llHdl-&gt;dbgHdl      </span>
<a name="l00131"></a><a class="code" href="z17__drv_8c.html#a7">00131</a> <span class="preprocessor">#define OSH                llHdl-&gt;osHdl       </span>
00133 <span class="preprocessor"></span><span class="comment">/* toggle mode defines */</span>
<a name="l00134"></a><a class="code" href="z17__drv_8c.html#a8">00134</a> <span class="preprocessor">#define TOG_TIME_DEFAULT   1000       </span>
<a name="l00135"></a><a class="code" href="z17__drv_8c.html#a9">00135</a> <span class="preprocessor">#define TOG_TIME_MIN       100        </span>
<a name="l00136"></a><a class="code" href="z17__drv_8c.html#a10">00136</a> <span class="preprocessor">#define TOG_TIME_MAX       60000      </span>
<a name="l00137"></a><a class="code" href="z17__drv_8c.html#a11">00137</a> <span class="preprocessor">#define TOG_CYCLIC         1          </span>
00139 <span class="preprocessor"></span><span class="comment">/* descriptor key defines*/</span>
<a name="l00140"></a><a class="code" href="z17__drv_8c.html#a12">00140</a> <span class="preprocessor">#define RESET_DEFAULT      0          </span>
<a name="l00141"></a><a class="code" href="z17__drv_8c.html#a13">00141</a> <span class="preprocessor">#define RESET_OFF          1          </span>
00143 <span class="preprocessor"></span><span class="comment">/*-----------------------------------------+</span>
00144 <span class="comment">|  TYPEDEFS                                |</span>
00145 <span class="comment">+-----------------------------------------*/</span>
00146 
<a name="l00147"></a><a class="code" href="structLL__HANDLE.html">00147</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00148     <span class="comment">/* general */</span>
<a name="l00149"></a><a class="code" href="structLL__HANDLE.html#m0">00149</a>     int32                   memAlloc;       
<a name="l00150"></a><a class="code" href="structLL__HANDLE.html#m1">00150</a>     OSS_HANDLE              *osHdl;         
<a name="l00151"></a><a class="code" href="structLL__HANDLE.html#m2">00151</a>     OSS_IRQ_HANDLE          *irqHdl;        
<a name="l00152"></a><a class="code" href="structLL__HANDLE.html#m3">00152</a>     DESC_HANDLE             *descHdl;       
<a name="l00153"></a><a class="code" href="structLL__HANDLE.html#m4">00153</a>     MACCESS                 ma;             
00154 <span class="preprocessor">#ifdef Z127_INFO_PTR</span>
00155 <span class="preprocessor"></span>    CHAMELEONV2_UNIT        *chamu;         
00156     u_int32                 vdt;            
00157 <span class="preprocessor">#endif</span>
<a name="l00158"></a><a class="code" href="structLL__HANDLE.html#m5">00158</a> <span class="preprocessor"></span>    MDIS_IDENT_FUNCT_TBL    idFuncTbl;      
00159     <span class="comment">/* debug */</span>
<a name="l00160"></a><a class="code" href="structLL__HANDLE.html#m6">00160</a>     u_int32                 dbgLevel;       
<a name="l00161"></a><a class="code" href="structLL__HANDLE.html#m7">00161</a>     DBG_HANDLE              *dbgHdl;        
00162 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00163 <span class="preprocessor"></span>    <span class="comment">/* misc */</span>
<a name="l00164"></a><a class="code" href="structLL__HANDLE.html#m8">00164</a>     OSS_SIG_HANDLE          *portChangeSig; 
<a name="l00165"></a><a class="code" href="structLL__HANDLE.html#m9">00165</a>     u_int32                 irqCount;       
<a name="l00166"></a><a class="code" href="structLL__HANDLE.html#m10">00166</a>     u_int32                 lastReq;        
00167     <span class="comment">/* IRQ latency test */</span>
<a name="l00168"></a><a class="code" href="structLL__HANDLE.html#m11">00168</a>     u_int32                 irqTest;        <span class="comment">/* test running flag (1=on) */</span>
<a name="l00169"></a><a class="code" href="structLL__HANDLE.html#m12">00169</a>     int32                   outBit;         <span class="comment">/* output bit 0..31       */</span>
<a name="l00170"></a><a class="code" href="structLL__HANDLE.html#m13">00170</a>     u_int32                 outLast;        <span class="comment">/* last set output value (1 or 0) */</span>
<a name="l00171"></a><a class="code" href="structLL__HANDLE.html#m14">00171</a>     u_int32                 irqs2fire;      <span class="comment">/* number of IRQs to fire */</span>
<a name="l00172"></a><a class="code" href="structLL__HANDLE.html#m15">00172</a>     u_int32                 startTick;      <span class="comment">/* start tick count       */</span>
<a name="l00173"></a><a class="code" href="structLL__HANDLE.html#m16">00173</a>     u_int32                 stopTick;       <span class="comment">/* stop tick count        */</span>
00174 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00175     <span class="comment">/* toggle mode */</span>
<a name="l00176"></a><a class="code" href="structLL__HANDLE.html#m17">00176</a>     OSS_ALARM_HANDLE        *alarmHdl;      
<a name="l00177"></a><a class="code" href="structLL__HANDLE.html#m18">00177</a>     OSS_SEM_HANDLE          *devSemHdl;     
<a name="l00178"></a><a class="code" href="structLL__HANDLE.html#m19">00178</a>     u_int32                 togHigh;        
<a name="l00179"></a><a class="code" href="structLL__HANDLE.html#m20">00179</a>     u_int32                 togtimeHigh;    
<a name="l00180"></a><a class="code" href="structLL__HANDLE.html#m21">00180</a>     u_int32                 togtimeLow;     
<a name="l00181"></a><a class="code" href="structLL__HANDLE.html#m22">00181</a>     u_int32                 togBitMask;     
<a name="l00182"></a><a class="code" href="structLL__HANDLE.html#m23">00182</a>     u_int32                 togCount;       
00183     <span class="comment">/* arwen no reset */</span>
<a name="l00184"></a><a class="code" href="structLL__HANDLE.html#m24">00184</a>     u_int32                 arwenResetOff;  
00185 } <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>;
00186 
00187 <span class="comment">/* include files which need LL_HANDLE */</span>
00188 <span class="preprocessor">#include &lt;MEN/ll_entry.h&gt;</span>       <span class="comment">/* low-level driver jump table */</span>
00189 <span class="preprocessor">#include &lt;<a class="code" href="z17__drv_8h.html">MEN/z17_drv.h</a>&gt;</span>        <span class="comment">/* Z17 driver header file      */</span>
00190 
00191 <span class="comment">/*-----------------------------------------+</span>
00192 <span class="comment">|  PROTOTYPES                              |</span>
00193 <span class="comment">+-----------------------------------------*/</span>
00194 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a14">Z17_Init</a>(DESC_SPEC *descSpec, OSS_HANDLE *osHdl,
00195                         MACCESS *ma, OSS_SEM_HANDLE *devSemHdl,
00196                         OSS_IRQ_HANDLE *irqHdl, <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP);
00197 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a15">Z17_Exit</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP);
00198 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a16">Z17_Read</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 *value);
00199 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a17">Z17_Write</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 value);
00200 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a18">Z17_SetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,int32 ch, int32 code,
00201                             INT32_OR_64 value32_or_64);
00202 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a19">Z17_GetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 code,
00203                             INT32_OR_64 *value32_or64P);
00204 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a20">Z17_BlockRead</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00205                             int32 *nbrRdBytesP);
00206 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a21">Z17_BlockWrite</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00207                                 int32 *nbrWrBytesP);
00208 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00209 <span class="preprocessor"></span>    <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a22">Z17_Irq</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl);
00210 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00211 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a23">Z17_Info</a>(int32 infoType, ...);
00212 <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z17__drv_8c.html#a24">Ident</a>(<span class="keywordtype">void</span>);
00213 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 retCode);
00214 <span class="keyword">static</span> <span class="keywordtype">void</span>  <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl);
00215 
00216 <span class="keyword">static</span> <span class="keywordtype">void</span>  <a class="code" href="z17__drv_8c.html#a27">AlarmHandler</a>(<span class="keywordtype">void</span> *arg);
00217 
00218 <span class="comment">/****************************** Z17_GetEntry ********************************/</span>
00223 <span class="preprocessor">#ifdef _ONE_NAMESPACE_PER_DRIVER_</span>
00224 <span class="preprocessor"></span>    <span class="keyword">extern</span> <span class="keywordtype">void</span> LL_GetEntry(
00225         LL_ENTRY* drvP
00226     )
00227 #<span class="keywordflow">else</span>
<a name="l00228"></a><a class="code" href="z17__drv_8c.html#a28">00228</a>     <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="z17__drv_8h.html#a19">__Z17_GetEntry</a>(
00229         LL_ENTRY* drvP
00230     )
00231 #endif
00232 {
00233     drvP-&gt;init        = <a class="code" href="z17__drv_8c.html#a14">Z17_Init</a>;
00234     drvP-&gt;exit        = <a class="code" href="z17__drv_8c.html#a15">Z17_Exit</a>;
00235     drvP-&gt;read        = <a class="code" href="z17__drv_8c.html#a16">Z17_Read</a>;
00236     drvP-&gt;write       = <a class="code" href="z17__drv_8c.html#a17">Z17_Write</a>;
00237     drvP-&gt;blockRead   = <a class="code" href="z17__drv_8c.html#a20">Z17_BlockRead</a>;
00238     drvP-&gt;blockWrite  = <a class="code" href="z17__drv_8c.html#a21">Z17_BlockWrite</a>;
00239     drvP-&gt;setStat     = <a class="code" href="z17__drv_8c.html#a18">Z17_SetStat</a>;
00240     drvP-&gt;getStat     = <a class="code" href="z17__drv_8c.html#a19">Z17_GetStat</a>;
00241 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00242 <span class="preprocessor"></span>    drvP-&gt;irq         = <a class="code" href="z17__drv_8c.html#a22">Z17_Irq</a>;
00243 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00244     drvP-&gt;info        = <a class="code" href="z17__drv_8c.html#a23">Z17_Info</a>;
00245 }
00246 
00247 <span class="comment">/******************************** Z17_Init **********************************/</span>
<a name="l00272"></a><a class="code" href="z17__drv_8c.html#a14">00272</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a14">Z17_Init</a>(
00273     DESC_SPEC       *descP,
00274     OSS_HANDLE      *osHdl,
00275     MACCESS         *ma,
00276     OSS_SEM_HANDLE  *devSemHdl,
00277     OSS_IRQ_HANDLE  *irqHdl,
00278     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>       **llHdlP
00279 )
00280 {
00281     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = NULL;
00282     u_int32 gotsize;
00283     int32 error;
00284     u_int32 value;
00285 
00286     <span class="comment">/*------------------------------+</span>
00287 <span class="comment">    |  prepare the handle           |</span>
00288 <span class="comment">    +------------------------------*/</span>
00289     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00290 
00291     <span class="comment">/* alloc */</span>
00292     <span class="keywordflow">if</span> ((llHdl = (<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>*)OSS_MemGet(
00293                     osHdl, <span class="keyword">sizeof</span>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>), &amp;gotsize)) == NULL)
00294         <span class="keywordflow">return</span> (ERR_OSS_MEM_ALLOC);
00295 
00296     <span class="comment">/* clear */</span>
00297     OSS_MemFill(osHdl, gotsize, (<span class="keywordtype">char</span>*)llHdl, 0x00);
00298 
00299     <span class="comment">/* init */</span>
00300     llHdl-&gt;memAlloc    = gotsize;
00301     llHdl-&gt;osHdl       = osHdl;
00302 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00303 <span class="preprocessor"></span>    llHdl-&gt;irqHdl      = irqHdl;
00304 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00305     llHdl-&gt;ma          = *ma;
00306     llHdl-&gt;devSemHdl   = devSemHdl;
00307     llHdl-&gt;togtimeHigh = <a class="code" href="z17__drv_8c.html#a8">TOG_TIME_DEFAULT</a>;
00308     llHdl-&gt;togtimeLow  = <a class="code" href="z17__drv_8c.html#a8">TOG_TIME_DEFAULT</a>;
00309     llHdl-&gt;togBitMask  = 0;
00310     llHdl-&gt;togCount    = 0;
00311     llHdl-&gt;togHigh     = 0;
00312 
00313 <span class="preprocessor">#ifdef Z127_INFO_PTR</span>
00314 <span class="preprocessor"></span>    llHdl-&gt;chamu       = (CHAMELEONV2_UNIT*)ma[1];
00315 <span class="preprocessor">#endif </span>
00316 <span class="preprocessor"></span>
00317     <span class="comment">/*------------------------------+</span>
00318 <span class="comment">    |  init id function table       |</span>
00319 <span class="comment">    +------------------------------*/</span>
00320     <span class="comment">/* driver's ident function */</span>
00321     llHdl-&gt;idFuncTbl.idCall[0].identCall = <a class="code" href="z17__drv_8c.html#a24">Ident</a>;
00322     <span class="comment">/* library's ident functions */</span>
00323     llHdl-&gt;idFuncTbl.idCall[1].identCall = DESC_Ident;
00324     llHdl-&gt;idFuncTbl.idCall[2].identCall = OSS_Ident;
00325     <span class="comment">/* terminator */</span>
00326     llHdl-&gt;idFuncTbl.idCall[3].identCall = NULL;
00327 
00328     <span class="comment">/*------------------------------+</span>
00329 <span class="comment">    |  prepare debugging            |</span>
00330 <span class="comment">    +------------------------------*/</span>
00331     <a class="code" href="z17__drv_8c.html#a5">DBG_MYLEVEL</a> = OSS_DBG_DEFAULT;      <span class="comment">/* set OS specific debug level */</span>
00332     DBGINIT((NULL,&amp;<a class="code" href="z17__drv_8c.html#a6">DBH</a>));
00333 
00334     <span class="comment">/*------------------------------+</span>
00335 <span class="comment">    |  scan descriptor              |</span>
00336 <span class="comment">    +------------------------------*/</span>
00337     <span class="comment">/* prepare access */</span>
00338     <span class="keywordflow">if</span> ((error = DESC_Init(descP, osHdl, &amp;llHdl-&gt;descHdl)))
00339         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00340 
00341     <span class="comment">/* DEBUG_LEVEL_DESC */</span>
00342     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00343                                 &amp;value, <span class="stringliteral">"DEBUG_LEVEL_DESC"</span>)) &amp;&amp;
00344         error != ERR_DESC_KEY_NOTFOUND)
00345         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00346 
00347     DESC_DbgLevelSet(llHdl-&gt;descHdl, value);    <span class="comment">/* set level */</span>
00348 
00349     <span class="comment">/* DEBUG_LEVEL */</span>
00350     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00351                                 &amp;llHdl-&gt;dbgLevel, <span class="stringliteral">"DEBUG_LEVEL"</span>)) &amp;&amp;
00352         error != ERR_DESC_KEY_NOTFOUND)
00353         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00354 
00355     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Init: base address = %08p\n"</span>, (<span class="keywordtype">void</span>*)llHdl-&gt;ma));
00356 
00357 <span class="preprocessor">#ifdef Z127_INFO_PTR</span>
00358 <span class="preprocessor"></span>    <span class="comment">/* print chameleon info */</span>
00359     DBGWRT_1(( <a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"   device ID:\t0x%02x \n"</span>,llHdl-&gt;chamu-&gt;devId));
00360     DBGWRT_1(( <a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"   variant:  \t0x%02x \n"</span>,llHdl-&gt;chamu-&gt;variant));
00361     DBGWRT_1(( <a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"   revision: \t0x%02x \n\n"</span>,llHdl-&gt;chamu-&gt;revision));
00362     
00363     <span class="keywordflow">if</span>( llHdl-&gt;chamu-&gt;variant &gt; 0 )
00364         llHdl-&gt;vdt = 1;
00365 <span class="preprocessor">#endif</span>
00366 <span class="preprocessor"></span>
00367     <span class="comment">/* RESET_OFF */</span>
00368     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, <a class="code" href="z17__drv_8c.html#a12">RESET_DEFAULT</a>,
00369                                 &amp;llHdl-&gt;arwenResetOff, <span class="stringliteral">"RESET_OFF"</span>)) &amp;&amp;
00370         error != ERR_DESC_KEY_NOTFOUND)
00371         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00372 
00373     <span class="comment">/*------------------------------+</span>
00374 <span class="comment">    |  init alarm                   |</span>
00375 <span class="comment">    +------------------------------*/</span>
00376     <span class="keywordflow">if</span> ((error = OSS_AlarmCreate(llHdl-&gt;osHdl, <a class="code" href="z17__drv_8c.html#a27">AlarmHandler</a>, llHdl,
00377                                     &amp;llHdl-&gt;alarmHdl)))
00378         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00379 
00380     <span class="comment">/*------------------------------+</span>
00381 <span class="comment">    |  init hardware                |</span>
00382 <span class="comment">    +------------------------------*/</span>
00383     <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(llHdl);
00384     *llHdlP = llHdl;        <span class="comment">/* set low-level driver handle */</span>
00385 
00386     <span class="keywordflow">return</span> (ERR_SUCCESS);
00387 }
00388 
00389 <span class="comment">/****************************** Z17_Exit ************************************/</span>
<a name="l00399"></a><a class="code" href="z17__drv_8c.html#a15">00399</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a15">Z17_Exit</a>(
00400     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP
00401 )
00402 {
00403     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = *llHdlP;
00404     int32 error = 0;
00405 
00406     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Exit\n"</span>));
00407 
00408     <span class="comment">/*------------------------------+</span>
00409 <span class="comment">    |  de-init hardware             |</span>
00410 <span class="comment">    +------------------------------*/</span>
00411     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m24">arwenResetOff</a> == 0)
00412         <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(llHdl);
00413     <span class="comment">/*------------------------------+</span>
00414 <span class="comment">    |  clean up memory              |</span>
00415 <span class="comment">    +------------------------------*/</span>
00416     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00417     error = <a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error);
00418 
00419     <span class="keywordflow">return</span> (error);
00420 }
00421 
00422 <span class="comment">/****************************** Z17_Read ************************************/</span>
<a name="l00433"></a><a class="code" href="z17__drv_8c.html#a16">00433</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a16">Z17_Read</a>(
00434     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>  *llHdl,
00435     int32      ch,
00436     int32      *valueP
00437 )
00438 {
00439     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Read: ch=%d\n"</span>, ch));
00440 
00441     *valueP = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_PSR);
00442 
00443     <span class="keywordflow">return</span> (ERR_SUCCESS);
00444 }
00445 
00446 <span class="comment">/****************************** Z17_Write ***********************************/</span>
<a name="l00457"></a><a class="code" href="z17__drv_8c.html#a17">00457</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a17">Z17_Write</a>(
00458     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>  *llHdl,
00459     int32      ch,
00460     int32      value
00461 )
00462 {
00463     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Write: ch=%d  val=0x%x\n"</span>, ch, value));
00464 
00465     MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_GPIO, value);
00466 
00467     <span class="keywordflow">return</span> (ERR_SUCCESS);
00468 }
00469 
00470 <span class="comment">/****************************** Z17_SetStat *********************************/</span>
<a name="l00484"></a><a class="code" href="z17__drv_8c.html#a18">00484</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a18">Z17_SetStat</a>(
00485     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>   *llHdl,
00486     int32       code,
00487     int32       ch,
00488     INT32_OR_64 value32_or_64
00489 )
00490 {
00491     int32 value = (int32)value32_or_64;     <span class="comment">/* 32bit value */</span>
00492     <a class="code" href="z17__drv_8h.html#a20">INT32_OR_64</a> valueP = value32_or_64;     <span class="comment">/* stores 32/64bit pointer */</span>
00493     M_SG_BLOCK *blk = (M_SG_BLOCK*)valueP;  <span class="comment">/* stores block struct pointer */</span>
00494 
00495     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>;
00496     int32 error = ERR_SUCCESS;
00497 
00498     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_SetStat: ch=%d code=0x%04x value=0x%x\n"</span>,
00499                 ch, code, value));
00500 
00501     <span class="keywordflow">switch</span> (code) {
00502         <span class="comment">/*--------------------------+</span>
00503 <span class="comment">        |  debug level              |</span>
00504 <span class="comment">        +--------------------------*/</span>
00505         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00506             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m6">dbgLevel</a> = value;
00507             <span class="keywordflow">break</span>;
00508         <span class="comment">/*--------------------------+</span>
00509 <span class="comment">        |  enable interrupts        |</span>
00510 <span class="comment">        +--------------------------*/</span>
00511         <span class="keywordflow">case</span> M_MK_IRQ_ENABLE:
00512             <span class="keywordflow">break</span>;
00513         <span class="comment">/*--------------------------+</span>
00514 <span class="comment">        |  set irq counter          |</span>
00515 <span class="comment">        +--------------------------*/</span>
00516         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00517 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00518 <span class="preprocessor"></span>            llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m9">irqCount</a> = value;
00519 <span class="preprocessor">#endif</span>
00520 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00521         <span class="comment">/*--------------------------+</span>
00522 <span class="comment">        |  channel direction        |</span>
00523 <span class="comment">        +--------------------------*/</span>
00524         <span class="keywordflow">case</span> M_LL_CH_DIR:
00525             <span class="keywordflow">if</span> (value != M_CH_INOUT) {
00526                 error = ERR_LL_ILL_DIR;
00527             }
00528             <span class="keywordflow">break</span>;
00529         <span class="comment">/*--------------------------+</span>
00530 <span class="comment">        |  set IO ports             |</span>
00531 <span class="comment">        +--------------------------*/</span>
00532         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a0">Z17_SET_PORTS</a>:
00533             MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO) | value);
00534             <span class="comment">/* remove bit from toggle mode */</span>
00535             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>) {
00536                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a> &amp;= ~value;
00537                 <span class="comment">/* stop alarm if last bit is set */</span>
00538                 <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>)
00539                     error = OSS_AlarmClear(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>);
00540             }
00541             <span class="keywordflow">break</span>;
00542         <span class="comment">/*--------------------------+</span>
00543 <span class="comment">        |  clear IO ports           |</span>
00544 <span class="comment">        +--------------------------*/</span>
00545         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a1">Z17_CLR_PORTS</a>:
00546             MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO) &amp; ~value);
00547             <span class="comment">/* remove bit from toggle mode */</span>
00548             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>) {
00549                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a> &amp;= ~value;
00550                 <span class="comment">/* stop alarm if last bit is cleared */</span>
00551                 <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>)
00552                     error = OSS_AlarmClear(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>);
00553             }
00554             <span class="keywordflow">break</span>;
00555         <span class="comment">/*--------------------------+</span>
00556 <span class="comment">        |  port direction           |</span>
00557 <span class="comment">        +--------------------------*/</span>
00558         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a2">Z17_DIRECTION</a>:
00559             MWRITE_D32(ma, ARWEN_DDR, value);
00560             <span class="keywordflow">break</span>;
00561 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00562 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00563 <span class="comment">        |  edge for interrupt       |</span>
00564 <span class="comment">        +--------------------------*/</span>
00565         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a3">Z17_IRQ_SENSE</a>:
00566 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00567 <span class="preprocessor"></span>        <span class="comment">/* Z34/Z37 - 8 GPIOs */</span>
00568             MWRITE_D32(ma, ARWEN_02_IER1, value &amp; 0xff);
00569             MWRITE_D32(ma, ARWEN_02_IER2, (value &gt;&gt; 8) &amp; 0xff);
00570             <span class="keywordflow">break</span>;
00571 <span class="preprocessor">#else</span>
00572 <span class="preprocessor"></span>        <span class="comment">/* Z127: GPIOs 0..15 - two bits per GPIO */</span>
00573             MWRITE_D32(ma, ARWEN_02_IER1, value);
00574             <span class="keywordflow">break</span>;
00575         <span class="comment">/* Z127: GPIOs 16..31 - two bits per GPIO */</span>
00576         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a9">Z17_IRQ_SENSE_16TO31</a>:
00577             MWRITE_D32(ma, ARWEN_02_IER2, value);
00578             <span class="keywordflow">break</span>;
00579 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00580 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00581         <span class="comment">/*--------------------------+</span>
00582 <span class="comment">        |  open drain               |</span>
00583 <span class="comment">        +--------------------------*/</span>
00584         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a4">Z17_OPEN_DRAIN</a>:
00585             MWRITE_D32(ma, ARWEN_02_ODER, value);
00586             <span class="keywordflow">break</span>;
00587         <span class="comment">/*--------------------------+</span>
00588 <span class="comment">        |  debouncer                |</span>
00589 <span class="comment">        +--------------------------*/</span>
00590         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a5">Z17_DEBOUNCE</a>:
00591             MWRITE_D32(ma, ARWEN_02_DBER, value);
00592             <span class="keywordflow">break</span>;
00593             
00594 <span class="preprocessor">#ifdef Z127_INFO_PTR            </span>
00595 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a15">Z17_BLK_DEBOUNCE_TIME</a>:
00596         {
00597             int8 port;
00598             <a class="code" href="structZ17__BLK__DEBTIME.html">Z17_BLK_DEBTIME</a> *dbt = (<a class="code" href="structZ17__BLK__DEBTIME.html">Z17_BLK_DEBTIME</a>*)blk-&gt;data;         
00599         
00600             <span class="comment">/* prevent access to not implemented DBCR registers */</span>      
00601             <span class="keywordflow">if</span>( llHdl-&gt;vdt == 0 ){
00602                 DBGWRT_ERR((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** LL - Z17_SetStat(Z17_BLK_DEBOUNCE_TIME): "</span>
00603                     <span class="stringliteral">" requires at least 16Z127 variant 1 IP core\n"</span>));
00604                 <span class="keywordflow">return</span> ERR_LL_ILL_FUNC;
00605             }
00606                     
00607             <span class="keywordflow">for</span>( port=0; port&lt;32; port++ ){
00608                 <span class="keywordflow">if</span>( (dbt-&gt;<a class="code" href="structZ17__BLK__DEBTIME.html#m0">portMask</a> &amp; (1&lt;&lt;port)) ){
00609                     MWRITE_D32(ma, ARWEN_Z127V01_DBCR(port), dbt-&gt;<a class="code" href="structZ17__BLK__DEBTIME.html#m1">timeUs</a>/50);
00610                 }
00611             }       
00612 
00613             <span class="keywordflow">break</span>;
00614         }
00615 <span class="preprocessor">#endif</span>
00616 <span class="preprocessor"></span>                    
00617 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00618 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00619 <span class="comment">        |  register signal          |</span>
00620 <span class="comment">        +--------------------------*/</span>
00621         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a6">Z17_SET_SIGNAL</a>:
00622             <span class="comment">/* signal already installed ? */</span>
00623             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a>) {
00624                 error = ERR_OSS_SIG_SET;
00625                 <span class="keywordflow">break</span>;
00626             }
00627             error = OSS_SigCreate(<a class="code" href="z17__drv_8c.html#a7">OSH</a>, value, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a>);
00628             <span class="keywordflow">break</span>;
00629         <span class="comment">/*--------------------------+</span>
00630 <span class="comment">        |  unregister signal        |</span>
00631 <span class="comment">        +--------------------------*/</span>
00632         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a7">Z17_CLR_SIGNAL</a>:
00633             <span class="comment">/* signal already installed ? */</span>
00634             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a> == NULL) {
00635                 error = ERR_OSS_SIG_CLR;
00636                 <span class="keywordflow">break</span>;
00637             }
00638             error = OSS_SigRemove(<a class="code" href="z17__drv_8c.html#a7">OSH</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a>);
00639             <span class="keywordflow">break</span>;
00640         <span class="comment">/*--------------------------+</span>
00641 <span class="comment">        |  init IRQ latency test    |</span>
00642 <span class="comment">        +--------------------------*/</span>
00643         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a13">Z17_BLK_IRQLAT_START</a>:
00644         {
00645             int32 value;
00646             <a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a> *irqlat = (<a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a>*)blk-&gt;data;
00647 
00648             <span class="comment">/* clear out values */</span>
00649             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m4">startTick</a> = 0;
00650             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m5">stopTick</a> = 0;
00651             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m6">irqsRcved</a> = 0;
00652 
00653             <span class="comment">/* init */</span>
00654             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m11">irqTest</a> = 1;
00655             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m14">irqs2fire</a> = irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m2">irqs2fire</a>-1;
00656             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m9">irqCount</a> = 0;
00657             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m16">stopTick</a> = 0;
00658 
00659             <span class="comment">/* compute and save output bit */</span>
00660             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m12">outBit</a> = 1 &lt;&lt; irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m0">outPort</a>;
00661 
00662             <span class="comment">/* disable all interrupts */</span>
00663             MWRITE_D32(ma, ARWEN_02_IER1, 0);
00664             MWRITE_D32(ma, ARWEN_02_IER2, 0);
00665 
00666             <span class="comment">/* program all ports as inputs */</span>
00667             MWRITE_D32(ma, ARWEN_DDR, 0);
00668 
00669             <span class="comment">/* determine actual state of output port */</span>
00670             value = MREAD_D32(ma, ARWEN_02_PSR);
00671             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a> = (value &amp; llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m12">outBit</a>) ? 1 : 0;
00672 
00673             <span class="comment">/* preset output port value */</span>
00674             MWRITE_D32(ma, ARWEN_GPIO, value);
00675 
00676             <span class="comment">/* enable IRQ for rising+falling edge of input port */</span>
00677 <span class="comment">/* Z34/Z37 - 8 GPIOs */</span>
00678 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00679 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a> &lt; 4) <span class="comment">/* port 3..0 */</span>
00680                 MWRITE_D32(ma, ARWEN_02_IER1, 3 &lt;&lt; (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a> * 2));
00681             <span class="keywordflow">else</span>    <span class="comment">/* port 8..4 */</span>
00682                 MWRITE_D32(ma, ARWEN_02_IER2, 3 &lt;&lt; ((irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a>-4) * 2));
00683 <span class="comment">/* Z127 - 32 GPIOs */</span>
00684 <span class="preprocessor">#else</span>
00685 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a> &lt; 16)    <span class="comment">/* port 15..0 */</span>
00686                 MWRITE_D32(ma, ARWEN_02_IER1, 3 &lt;&lt; (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a> * 2));
00687             <span class="keywordflow">else</span>    <span class="comment">/* port 32..16 */</span>
00688                 MWRITE_D32(ma, ARWEN_02_IER2, 3 &lt;&lt; ((irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a>-16) * 2));
00689 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00690             <span class="comment">/* config port as output (default is input) */</span>
00691             MWRITE_D32(ma, ARWEN_DDR, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m12">outBit</a>);
00692 
00693             <span class="comment">/* set output (this fires the first IRQ) */</span>
00694             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a> = !llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a>;
00695             DBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"set output=0x%x, irqs2fire=%d\n"</span>,
00696                         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m14">irqs2fire</a>));
00697             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m15">startTick</a> = OSS_TickGet(<a class="code" href="z17__drv_8c.html#a7">OSH</a>);
00698             MWRITE_D32(ma, ARWEN_GPIO, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a> ? llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m12">outBit</a> : 0);
00699             <span class="keywordflow">break</span>;
00700         }
00701 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00702         <span class="comment">/*--------------------------+</span>
00703 <span class="comment">        |  Toggle mode              |</span>
00704 <span class="comment">        +--------------------------*/</span>
00705         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a10">Z17_TOG_PORTS</a>:
00706         {
00707             u_int32 realMsec;
00708 
00709             <span class="comment">/* start timer initially */</span>
00710             <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>) {
00711                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a> = value;
00712                 error = OSS_AlarmSet(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>,
00713                                         <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>, <a class="code" href="z17__drv_8c.html#a11">TOG_CYCLIC</a>, &amp;realMsec);
00714             } <span class="keywordflow">else</span> {
00715                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a> |= value;
00716                 <span class="comment">/* reset timer */</span>
00717                 error = OSS_AlarmClear(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>);
00718                 error = OSS_AlarmSet(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>,
00719                                         <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>, <a class="code" href="z17__drv_8c.html#a11">TOG_CYCLIC</a>, &amp;realMsec);
00720             }
00721             <span class="keywordflow">break</span>;
00722         }
00723         <span class="comment">/*--------------------------+</span>
00724 <span class="comment">        |  Toggle mode - high       |</span>
00725 <span class="comment">        +--------------------------*/</span>
00726         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a11">Z17_TOG_HIGH</a>:
00727             <span class="comment">/* adjust time value (100ms resolution) */</span>
00728             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> = (value / <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>) * <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00729             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> &gt; <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>)
00730                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> = <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>;
00731             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> &lt; <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>)
00732                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> = <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00733             <span class="keywordflow">break</span>;
00734         <span class="comment">/*--------------------------+</span>
00735 <span class="comment">        |  Toggle mode - low        |</span>
00736 <span class="comment">        +--------------------------*/</span>
00737         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a12">Z17_TOG_LOW</a>:
00738             <span class="comment">/* adjust time value (100ms resolution) */</span>
00739             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a> = (value / <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>) * <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00740             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a> &gt; <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>)
00741                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a> = <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>;
00742             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a> &lt; <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>)
00743                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a> = <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00744             <span class="keywordflow">break</span>;
00745         <span class="comment">/*--------------------------+</span>
00746 <span class="comment">        |  (unknown)                |</span>
00747 <span class="comment">        +--------------------------*/</span>
00748         <span class="keywordflow">default</span>:
00749             error = ERR_LL_UNK_CODE;
00750     }
00751 
00752     <span class="keywordflow">return</span> (error);
00753 }
00754 
00755 <span class="comment">/****************************** Z17_GetStat *********************************/</span>
<a name="l00772"></a><a class="code" href="z17__drv_8c.html#a19">00772</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a19">Z17_GetStat</a>(
00773     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>   *llHdl,
00774     int32       code,
00775     int32       ch,
00776     INT32_OR_64 *value32_or_64P
00777 )
00778 {
00779     int32 *valueP = (int32*)value32_or_64P;     <span class="comment">/* pointer to 32bit value */</span>
00780     <a class="code" href="z17__drv_8h.html#a20">INT32_OR_64</a> *value64P = value32_or_64P;     <span class="comment">/* stores 32/64bit pointer */</span>
00781     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>;
00782     int32 error = ERR_SUCCESS;
00783     M_SG_BLOCK *blk = (M_SG_BLOCK*)value32_or_64P;  <span class="comment">/* stores block struct pointer; not needed here */</span>
00784 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00785 <span class="preprocessor"></span>    OSS_IRQ_STATE irqState;
00786 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00787 
00788     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_GetStat: ch=%d code=0x%04x\n"</span>, ch, code));
00789 
00790     <span class="keywordflow">switch</span> (code) {
00791         <span class="comment">/*--------------------------+</span>
00792 <span class="comment">        |  debug level              |</span>
00793 <span class="comment">        +--------------------------*/</span>
00794         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00795             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m6">dbgLevel</a>;
00796             <span class="keywordflow">break</span>;
00797         <span class="comment">/*--------------------------+</span>
00798 <span class="comment">        |  number of channels       |</span>
00799 <span class="comment">        +--------------------------*/</span>
00800         <span class="keywordflow">case</span> M_LL_CH_NUMBER:
00801             *valueP = <a class="code" href="z17__drv_8c.html#a1">CH_NUMBER</a>;
00802             <span class="keywordflow">break</span>;
00803         <span class="comment">/*--------------------------+</span>
00804 <span class="comment">        |  channel direction        |</span>
00805 <span class="comment">        +--------------------------*/</span>
00806         <span class="keywordflow">case</span> M_LL_CH_DIR:
00807             *valueP = M_CH_INOUT;
00808             <span class="keywordflow">break</span>;
00809         <span class="comment">/*--------------------------+</span>
00810 <span class="comment">        |  channel length [bits]    |</span>
00811 <span class="comment">        +--------------------------*/</span>
00812         <span class="keywordflow">case</span> M_LL_CH_LEN:
00813 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00814 <span class="preprocessor"></span>            <span class="comment">/* Z34 / Z37 */</span>
00815             *valueP = 8;
00816             <span class="keywordflow">break</span>;
00817 <span class="preprocessor">#else</span>
00818 <span class="preprocessor"></span>            <span class="comment">/* Z127 */</span>
00819             *valueP = 32;
00820             <span class="keywordflow">break</span>;
00821 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00822         <span class="comment">/*--------------------------+</span>
00823 <span class="comment">        |  channel type info        |</span>
00824 <span class="comment">        +--------------------------*/</span>
00825         <span class="keywordflow">case</span> M_LL_CH_TYP:
00826             *valueP = M_CH_BINARY;
00827             <span class="keywordflow">break</span>;
00828         <span class="comment">/*--------------------------+</span>
00829 <span class="comment">        |  irq counter              |</span>
00830 <span class="comment">        +--------------------------*/</span>
00831         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00832 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00833 <span class="preprocessor"></span>            *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m9">irqCount</a>;
00834 <span class="preprocessor">#endif</span>
00835 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00836         <span class="comment">/*--------------------------+</span>
00837 <span class="comment">        |  ID PROM check enabled    |</span>
00838 <span class="comment">        +--------------------------*/</span>
00839         <span class="keywordflow">case</span> M_LL_ID_CHECK:
00840             *valueP = 0;
00841             <span class="keywordflow">break</span>;
00842         <span class="comment">/*--------------------------+</span>
00843 <span class="comment">        |  ident table pointer      |</span>
00844 <span class="comment">        |  (treat as non-block!)    |</span>
00845 <span class="comment">        +--------------------------*/</span>
00846         <span class="keywordflow">case</span> M_MK_BLK_REV_ID:
00847             *value64P = (INT32_OR_64)&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m5">idFuncTbl</a>;
00848             <span class="keywordflow">break</span>;
00849         <span class="comment">/*--------------------------+</span>
00850 <span class="comment">        |  port direction           |</span>
00851 <span class="comment">        +--------------------------*/</span>
00852         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a2">Z17_DIRECTION</a>:
00853             *valueP = MREAD_D32(ma, ARWEN_DDR);
00854             <span class="keywordflow">break</span>;
00855 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00856 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00857 <span class="comment">        |  edge for interrupt       |</span>
00858 <span class="comment">        +--------------------------*/</span>
00859         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a3">Z17_IRQ_SENSE</a>:
00860 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00861 <span class="preprocessor"></span>            <span class="comment">/* Z34/Z37 */</span>
00862             *valueP = MREAD_D32(ma, ARWEN_02_IER1) |
00863                         MREAD_D32(ma, ARWEN_02_IER2) &lt;&lt; 8;
00864             <span class="keywordflow">break</span>;
00865 <span class="preprocessor">#else</span>
00866 <span class="preprocessor"></span>            <span class="comment">/* Z127: GPIOs 0..15 - two bits per GPIO */</span>
00867             *valueP = MREAD_D32(ma, ARWEN_02_IER1);
00868             <span class="keywordflow">break</span>;
00869         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a9">Z17_IRQ_SENSE_16TO31</a>:
00870             <span class="comment">/* Z127: GPIOs 16..31 - two bits per GPIO */</span>
00871             *valueP = MREAD_D32(ma, ARWEN_02_IER2);
00872             <span class="keywordflow">break</span>;
00873 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00874 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00875         <span class="comment">/*--------------------------+</span>
00876 <span class="comment">        |  open drain               |</span>
00877 <span class="comment">        +--------------------------*/</span>
00878         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a4">Z17_OPEN_DRAIN</a>:
00879             *valueP = MREAD_D32(ma, ARWEN_02_ODER);
00880             <span class="keywordflow">break</span>;
00881         <span class="comment">/*--------------------------+</span>
00882 <span class="comment">        |  debouncer                |</span>
00883 <span class="comment">        +--------------------------*/</span>
00884         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a5">Z17_DEBOUNCE</a>:
00885             *valueP = MREAD_D32(ma, ARWEN_02_DBER);
00886             <span class="keywordflow">break</span>;
00887 
00888 <span class="preprocessor">#ifdef Z127_INFO_PTR            </span>
00889 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a15">Z17_BLK_DEBOUNCE_TIME</a>:
00890         {
00891             int8    port, first=0;
00892             u_int32 timeUs=0;
00893             <a class="code" href="structZ17__BLK__DEBTIME.html">Z17_BLK_DEBTIME</a> *dbt = (<a class="code" href="structZ17__BLK__DEBTIME.html">Z17_BLK_DEBTIME</a>*)blk-&gt;data;         
00894             
00895             <span class="comment">/* prevent access to not implemented DBCR registers */</span>      
00896             <span class="keywordflow">if</span>( llHdl-&gt;vdt == 0 ){
00897                 DBGWRT_ERR((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** LL - Z17_GetStat(Z17_BLK_DEBOUNCE_TIME): "</span>
00898                     <span class="stringliteral">" requires at least 16Z127 variant 1 IP core\n"</span>));
00899                 <span class="keywordflow">return</span> ERR_LL_ILL_FUNC;
00900             }
00901 
00902             <span class="keywordflow">if</span>( dbt-&gt;<a class="code" href="structZ17__BLK__DEBTIME.html#m0">portMask</a> == 0 ){
00903                 DBGWRT_ERR((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** LL - Z17_GetStat(Z17_BLK_DEBOUNCE_TIME): "</span>
00904                     <span class="stringliteral">"no port specified\n"</span>));
00905                 <span class="keywordflow">return</span> ERR_LL_ILL_PARAM;
00906             }
00907         
00908             <span class="keywordflow">for</span>( port=0; port&lt;32; port++ ){
00909                 <span class="keywordflow">if</span>( (dbt-&gt;<a class="code" href="structZ17__BLK__DEBTIME.html#m0">portMask</a> &amp; (1&lt;&lt;port)) ){
00910                     <span class="keywordflow">if</span>( first&gt;0 ){
00911                         DBGWRT_ERR((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** LL - Z17_GetStat(Z17_BLK_DEBOUNCE_TIME): "</span>
00912                             <span class="stringliteral">"more than one port specified\n"</span>));
00913                         <span class="keywordflow">return</span> ERR_LL_ILL_PARAM;
00914                     }
00915                     timeUs = 50 * MREAD_D32(ma, ARWEN_Z127V01_DBCR(port));
00916                     first++;
00917                 }
00918             }
00919             
00920             dbt-&gt;<a class="code" href="structZ17__BLK__DEBTIME.html#m1">timeUs</a> = timeUs;       
00921             <span class="keywordflow">break</span>;
00922         }
00923 <span class="preprocessor">#endif                  </span>
00924 <span class="preprocessor"></span>            
00925 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00926 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00927 <span class="comment">        |  last IRQ request         |</span>
00928 <span class="comment">        +--------------------------*/</span>
00929         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a8">Z17_IRQ_LAST_REQUEST</a>:
00930             irqState = OSS_IrqMaskR(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m2">irqHdl</a>);
00931             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m10">lastReq</a>;
00932             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m10">lastReq</a> = 0;
00933             OSS_IrqRestore(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m2">irqHdl</a>, irqState);
00934             <span class="keywordflow">break</span>;
00935         <span class="comment">/*--------------------------+</span>
00936 <span class="comment">        |  IRQ latency test result  |</span>
00937 <span class="comment">        +--------------------------*/</span>
00938         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a14">Z17_BLK_IRQLAT_RESULT</a>:
00939         {
00940             <a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a> *irqlat = (<a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a>*)blk-&gt;data;
00941 
00942             <span class="comment">/* IRQ latency test not started? */</span>
00943             <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m11">irqTest</a>) {
00944                 error = ERR_LL_DEV_NOTRDY;
00945                 <span class="keywordflow">break</span>;
00946             }
00947             <span class="comment">/* IRQ latency test not yet finished? */</span>
00948             <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m16">stopTick</a>) {
00949                 error = ERR_LL_DEV_BUSY;
00950                 <span class="keywordflow">break</span>;
00951             }
00952             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m11">irqTest</a> = 0;
00953 
00954             <span class="comment">/* disable all IRQs */</span>
00955             MWRITE_D32(ma, ARWEN_02_IER1, 0);
00956             MWRITE_D32(ma, ARWEN_02_IER2, 0);
00957 
00958             <span class="comment">/* reset all outputs */</span>
00959             MWRITE_D32(ma, ARWEN_GPIO, 0);
00960 
00961             <span class="comment">/* program all ports as inputs */</span>
00962             MWRITE_D32(ma, ARWEN_DDR, 0);
00963 
00964             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m3">tickRate</a> = OSS_TickRateGet(<a class="code" href="z17__drv_8c.html#a7">OSH</a>);
00965             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m4">startTick</a> = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m15">startTick</a>;
00966             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m5">stopTick</a> = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m16">stopTick</a>;
00967             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m6">irqsRcved</a> = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m9">irqCount</a>;
00968             <span class="keywordflow">break</span>;
00969         }
00970 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00971         <span class="comment">/*--------------------------+</span>
00972 <span class="comment">        |  (unknown)                |</span>
00973 <span class="comment">        +--------------------------*/</span>
00974         <span class="keywordflow">default</span>:
00975             error = ERR_LL_UNK_CODE;
00976     }
00977 
00978     <span class="keywordflow">return</span> (error);
00979 }
00980 
00981 <span class="comment">/******************************* Z17_BlockRead ******************************/</span>
<a name="l00992"></a><a class="code" href="z17__drv_8c.html#a20">00992</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a20">Z17_BlockRead</a>(
00993     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00994     int32     ch,
00995     <span class="keywordtype">void</span>      *buf,
00996     int32     size,
00997     int32     *nbrRdBytesP
00998 )
00999 {
01000     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_BlockRead: ch=%d, size=%d\n"</span>, ch, size));
01001 
01002     <span class="comment">/* return number of read bytes */</span>
01003     *nbrRdBytesP = 0;
01004 
01005     <span class="keywordflow">return</span> (ERR_LL_ILL_FUNC);
01006 }
01007 
01008 <span class="comment">/****************************** Z17_BlockWrite *****************************/</span>
<a name="l01019"></a><a class="code" href="z17__drv_8c.html#a21">01019</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a21">Z17_BlockWrite</a>(
01020     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
01021     int32     ch,
01022     <span class="keywordtype">void</span>      *buf,
01023     int32     size,
01024     int32     *nbrWrBytesP
01025 )
01026 {
01027     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_BlockWrite: ch=%d, size=%d\n"</span>, ch, size));
01028 
01029     <span class="comment">/* return number of written bytes */</span>
01030     *nbrWrBytesP = 0;
01031 
01032     <span class="keywordflow">return</span> (ERR_LL_ILL_FUNC);
01033 }
01034 
01035 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
01036 <span class="preprocessor"></span><span class="comment">/****************************** Z17_Irq ************************************/</span>
<a name="l01055"></a><a class="code" href="z17__drv_8c.html#a22">01055</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a22">Z17_Irq</a>(
01056     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl
01057 )
01058 {
01059     u_int32 irqReq;
01060     u_int32 ier1, ier2;
01061 
01062     <span class="comment">/* interrupt caused by Arwen ? */</span>
01063     irqReq = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_IRR);
01064 
01065     IDBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; LL - Z17_Irq: request %08x\n"</span>, irqReq));
01066     
01067     <span class="keywordflow">if</span> (irqReq) {
01068 
01069         <span class="comment">/* save IERs */</span>
01070         ier1 = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER1);
01071         ier2 = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER2);
01072         <span class="comment">/* disable all IRQs (for MSI(x)) */</span>
01073         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER1, 0);
01074         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER2, 0);
01075 
01076         <span class="comment">/* clear interrupt */</span>
01077         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_IRR, irqReq);
01078         
01079         <span class="comment">/* if requested send signal to application */</span>
01080         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a>)
01081             OSS_SigSend(<a class="code" href="z17__drv_8c.html#a7">OSH</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a>);
01082         
01083         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m9">irqCount</a>++;
01084         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m10">lastReq</a> = irqReq;
01085         
01086         <span class="comment">/* IRQ latency test */</span>
01087         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m11">irqTest</a>) {
01088             <span class="comment">/* pending IRQs to fire? */</span>
01089             IDBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; Z17_Irq: irqs2fire=%d\n"</span>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m14">irqs2fire</a>));
01090             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m14">irqs2fire</a>) {
01091                 <span class="comment">/* set output (this fires the next IRQ) */</span>
01092                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a> = !llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a>;
01093                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m14">irqs2fire</a>--;
01094                 IDBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; Z17_Irq: set output 0x%x\n"</span>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a>));
01095                 MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_GPIO, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a> ? llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m12">outBit</a> : 0);
01096             } <span class="keywordflow">else</span> {
01097                 <span class="comment">/* this was the last IRQ */</span>
01098                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m16">stopTick</a> = OSS_TickGet(<a class="code" href="z17__drv_8c.html#a7">OSH</a>);
01099             }
01100         }<span class="comment">/* IRQ latency test */</span>
01101         
01102         <span class="comment">/* enable all IRQs (for MSI(x)) */</span>
01103         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER1, ier1);
01104         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER2, ier2);
01105 
01106         <span class="keywordflow">return</span> (LL_IRQ_DEVICE);
01107     }
01108 
01109     <span class="keywordflow">return</span> (LL_IRQ_DEV_NOT);
01110 }
01111 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
01112 
01113 <span class="comment">/****************************** Z17_Info ***********************************/</span>
<a name="l01151"></a><a class="code" href="z17__drv_8c.html#a23">01151</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a23">Z17_Info</a>(
01152     int32 infoType,
01153     ...
01154 )
01155 {
01156     int32   error = ERR_SUCCESS;
01157     va_list argptr;
01158 
01159     va_start(argptr, infoType);
01160 
01161     <span class="keywordflow">switch</span> (infoType) {
01162         <span class="comment">/*-------------------------------+</span>
01163 <span class="comment">        |  hardware characteristics      |</span>
01164 <span class="comment">        |  (all addr/data modes ORed)    |</span>
01165 <span class="comment">        +-------------------------------*/</span>
01166         <span class="keywordflow">case</span> LL_INFO_HW_CHARACTER:
01167         {
01168             u_int32 *addrModeP = va_arg(argptr, u_int32*);
01169             u_int32 *dataModeP = va_arg(argptr, u_int32*);
01170         
01171             *addrModeP = MDIS_MA08;
01172             *dataModeP = MDIS_MD08 | MDIS_MD16;
01173             <span class="keywordflow">break</span>;
01174         }
01175         <span class="comment">/*-------------------------------+</span>
01176 <span class="comment">        |  nr of required address spaces |</span>
01177 <span class="comment">        |  (total spaces used)           |</span>
01178 <span class="comment">        +-------------------------------*/</span>
01179         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE_COUNT:
01180         {
01181             u_int32 *nbrOfAddrSpaceP = va_arg(argptr, u_int32*);
01182         
01183             *nbrOfAddrSpaceP = <a class="code" href="z17__drv_8c.html#a3">ADDRSPACE_COUNT</a>;
01184             <span class="keywordflow">break</span>;
01185         }
01186         <span class="comment">/*-------------------------------+</span>
01187 <span class="comment">        |  address space type            |</span>
01188 <span class="comment">        |  (widest used data mode)       |</span>
01189 <span class="comment">        +-------------------------------*/</span>
01190         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE:
01191         {
01192             u_int32 addrSpaceIndex = va_arg(argptr, u_int32);
01193             u_int32 *addrModeP = va_arg(argptr, u_int32*);
01194             u_int32 *dataModeP = va_arg(argptr, u_int32*);
01195             u_int32 *addrSizeP = va_arg(argptr, u_int32*);
01196         
01197             <span class="keywordflow">switch</span>( addrSpaceIndex ){
01198                 <span class="keywordflow">case</span> 0:
01199                     *addrModeP = MDIS_MA08;
01200                     *dataModeP = MDIS_MD16;
01201                     *addrSizeP = <a class="code" href="z17__drv_8c.html#a4">ADDRSPACE_SIZE</a>;
01202                     <span class="keywordflow">break</span>;
01203 <span class="preprocessor">#ifdef Z127_INFO_PTR</span>
01204 <span class="preprocessor"></span>                <span class="keywordflow">case</span> 1:
01205                     *addrModeP = MDIS_MA_BB_INFO_PTR;
01206                     *dataModeP = MDIS_MD_CHAM_0;
01207                     *addrSizeP = <span class="keyword">sizeof</span>(CHAMELEONV2_UNIT);
01208                     <span class="keywordflow">break</span>;
01209 <span class="preprocessor">#endif</span>
01210 <span class="preprocessor"></span>
01211                 <span class="keywordflow">default</span>:
01212                     error = ERR_LL_ILL_PARAM;
01213             }
01214             <span class="keywordflow">break</span>;
01215         }
01216         <span class="comment">/*-------------------------------+</span>
01217 <span class="comment">        |  interrupt required            |</span>
01218 <span class="comment">        +-------------------------------*/</span>
01219         <span class="keywordflow">case</span> LL_INFO_IRQ:
01220         {
01221             u_int32 *useIrqP = va_arg(argptr, u_int32*);
01222 
01223             *useIrqP = <a class="code" href="z17__drv_8c.html#a2">USE_IRQ</a>;
01224             <span class="keywordflow">break</span>;
01225         }
01226         <span class="comment">/*-------------------------------+</span>
01227 <span class="comment">        |  process lock mode             |</span>
01228 <span class="comment">        +-------------------------------*/</span>
01229         <span class="keywordflow">case</span> LL_INFO_LOCKMODE:
01230         {
01231             u_int32 *lockModeP = va_arg(argptr, u_int32*);
01232 
01233             *lockModeP = LL_LOCK_CALL;
01234             <span class="keywordflow">break</span>;
01235         }
01236         <span class="comment">/*-------------------------------+</span>
01237 <span class="comment">        |  (unknown)                     |</span>
01238 <span class="comment">        +-------------------------------*/</span>
01239         <span class="keywordflow">default</span>:
01240             error = ERR_LL_ILL_PARAM;
01241     }
01242 
01243     va_end(argptr);
01244 
01245     <span class="keywordflow">return</span> (error);
01246 }
01247 
01248 <span class="comment">/******************************** Ident ************************************/</span>
<a name="l01253"></a><a class="code" href="z17__drv_8c.html#a24">01253</a> <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z17__drv_8c.html#a24">Ident</a>(<span class="keywordtype">void</span>)
01254 {
01255     <span class="keywordflow">return</span> (<span class="stringliteral">"Z17 - Z17 low level driver: $Id: z17_drv.c,v 1.15 2017/05/03 16:52:05 DPfeuffer Exp $"</span>
01256 <span class="preprocessor">            #ifdef Z17_MODEL_Z127</span>
01257 <span class="preprocessor"></span>                <span class="stringliteral">" Z127 model"</span>
01258 <span class="preprocessor">            #else</span>
01259 <span class="preprocessor"></span>                <span class="stringliteral">" Z34/Z37 model"</span>
01260 <span class="preprocessor">            #endif</span>
01261 <span class="preprocessor"></span><span class="preprocessor">            #ifdef Z127_NOIRQ</span>
01262 <span class="preprocessor"></span>                <span class="stringliteral">" - no IRQs"</span>
01263 <span class="preprocessor">            #endif</span>
01264 <span class="preprocessor"></span>            );
01265 }
01266 
01267 <span class="comment">/********************************* Cleanup *********************************/</span>
<a name="l01277"></a><a class="code" href="z17__drv_8c.html#a25">01277</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(
01278     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
01279     int32     retCode
01280 )
01281 {
01282     <span class="comment">/*------------------------------+</span>
01283 <span class="comment">    |  close handles                |</span>
01284 <span class="comment">    +------------------------------*/</span>
01285     <span class="comment">/* clean up desc */</span>
01286     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m3">descHdl</a>)
01287         DESC_Exit(&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m3">descHdl</a>);
01288 
01289     <span class="comment">/* clean up alarm */</span>
01290     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>)
01291         OSS_AlarmRemove(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>);
01292 
01293     <span class="comment">/* clean up debug */</span>
01294     DBGEXIT((&amp;<a class="code" href="z17__drv_8c.html#a6">DBH</a>));
01295 
01296     <span class="comment">/*------------------------------+</span>
01297 <span class="comment">    |  free memory                  |</span>
01298 <span class="comment">    +------------------------------*/</span>
01299     <span class="comment">/* free my handle */</span>
01300     OSS_MemFree(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, (int8*)llHdl, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m0">memAlloc</a>);
01301 
01302     <span class="comment">/*return error code */</span>
01303     <span class="keywordflow">return</span> (retCode);
01304 }
01305 
01306 <span class="comment">/******************************* arwenReset ********************************/</span>
<a name="l01316"></a><a class="code" href="z17__drv_8c.html#a26">01316</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(
01317     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl
01318 )
01319 {
01320     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>;
01321 
01322     <span class="comment">/* disable all interrupts */</span>
01323     MWRITE_D32(ma, ARWEN_02_IER1, 0);
01324     MWRITE_D32(ma, ARWEN_02_IER2, 0);
01325 
01326     <span class="comment">/* program all ports as inputs */</span>
01327     MWRITE_D32(ma, ARWEN_DDR, 0);
01328 
01329     <span class="comment">/* disable open drain and debouncer */</span>
01330     MWRITE_D32(ma, ARWEN_02_ODER, 0);
01331     MWRITE_D32(ma, ARWEN_02_DBER, 0);
01332 }
01333 
01334 <span class="comment">/******************************* AlarmHandler ******************************/</span>
<a name="l01341"></a><a class="code" href="z17__drv_8c.html#a27">01341</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z17__drv_8c.html#a27">AlarmHandler</a>(
01342     <span class="keywordtype">void</span> *arg
01343 )
01344 {
01345     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = (<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>*)arg;
01346     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>;
01347 
01348     DBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; LL - Z17_Z127 AlarmHandler:\n"</span>));
01349 
01350     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m23">togCount</a> += <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
01351 
01352     <span class="comment">/* reset counter */</span>
01353     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m23">togCount</a> &gt; ((llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> + llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a>)))
01354         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m23">togCount</a> = 0;
01355 
01356     <span class="comment">/* toggle high */</span>
01357     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m19">togHigh</a> &amp;&amp; (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m23">togCount</a> &lt;= (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a>))) {
01358 
01359         <span class="comment">/* lock device */</span>
01360         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>)
01361             OSS_SemWait(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>, OSS_SEM_WAITFOREVER);
01362 
01363         MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO)
01364                                     | llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>);
01365 
01366         <span class="comment">/* release device (for other processes) */</span>
01367         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>)
01368             OSS_SemSignal(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>);
01369 
01370         <span class="comment">/* reset flag */</span>
01371         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m19">togHigh</a> = 0;
01372     }
01373 
01374     <span class="comment">/* toggle low */</span>
01375     <span class="keywordflow">if</span> ((!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m19">togHigh</a>) &amp;&amp; (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m23">togCount</a> &gt; (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a>))) {
01376 
01377         <span class="comment">/* lock device */</span>
01378         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>)
01379             OSS_SemWait(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>, OSS_SEM_WAITFOREVER);
01380 
01381         MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO)
01382                                     &amp; ~(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>));
01383 
01384         <span class="comment">/* release device (for other processes) */</span>
01385         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>)
01386             OSS_SemSignal(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>);
01387 
01388         <span class="comment">/* reset flag */</span>
01389         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m19">togHigh</a> = 1;
01390     }
01391 }
01392  
01393  
01394  
01395  
01396  
</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for Z17 MDIS Driver using <a href="http://www.doxygen.org">doxygen</a>.<br>
	Copyright &copy; 2017 <a href="http://www.men.de">MEN Mikro Elektronik GmbH</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

