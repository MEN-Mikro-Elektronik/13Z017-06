<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - Z17 MDIS Driver - z17_drv.c Source File</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;"></a>
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">Z17 MDIS Driver &nbsp; </h1>
	<h3>z17_drv.c Source File</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>z17_drv.c</h1><a href="z17__drv_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*********************  P r o g r a m  -  M o d u l e ***********************/</span>
00018  <span class="comment">/*-------------------------------[ History ]--------------------------------</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> * $Log: z17_drv.c,v $</span>
00021 <span class="comment"> * Revision 1.11  2014/11/28 14:17:37  MRoth</span>
00022 <span class="comment"> * R: 1.) no toggle function for GPIOs</span>
00023 <span class="comment"> *    2.) Z127 variant always requested an IRQ even if it had none in Hardware</span>
00024 <span class="comment"> *    3.) no support for MSI(x) - no IRQ should happen during ISR</span>
00025 <span class="comment"> *    4.) GPIO reset at driver exit (m_close) not always wanted</span>
00026 <span class="comment"> *    5.) cosmetics</span>
00027 <span class="comment"> * M: 1.a) added setstats Z17_TOG_PORTS, Z17_TOG_HIGH, Z17_TOG_LOW</span>
00028 <span class="comment"> *      b) added AlarmHandler() for timer</span>
00029 <span class="comment"> *    2.) introduced Z127_NOIRQ variant to inhibit IRQs.</span>
00030 <span class="comment"> *    3.) disable IRQs at the beginning and re-enable at the end of the ISR</span>
00031 <span class="comment"> *    4.) added RESET_OFF descriptor key to init function</span>
00032 <span class="comment"> *    5.) revised code completely</span>
00033 <span class="comment"> *</span>
00034 <span class="comment"> * Revision 1.10  2011/11/16 15:24:31  GLeonhardt</span>
00035 <span class="comment"> * R: 1.) Interrupts for GPIO 4-7 did not work with Z34/Z37 core</span>
00036 <span class="comment"> *        A preprocessor string comparison did not work.</span>
00037 <span class="comment"> *        Driver always compiled as Z127 model with 32 bit registers.</span>
00038 <span class="comment"> * M: 1.) Replace string comparison with driver switch from Makefile.</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> * Revision 1.9  2011/09/12 13:51:23  GLeonhardt</span>
00041 <span class="comment"> * R: Compiler error, if MWRITE_D32 macro is a compound statement</span>
00042 <span class="comment"> * M: Embed macro in braces</span>
00043 <span class="comment"> *</span>
00044 <span class="comment"> * Revision 1.8  2011/07/27 15:17:49  dpfeuffer</span>
00045 <span class="comment"> * R: IRQ latency test initialization problem</span>
00046 <span class="comment"> * M: IRQ latency test initialization revised</span>
00047 <span class="comment"> *</span>
00048 <span class="comment"> * Revision 1.7  2011/07/08 13:20:09  dpfeuffer</span>
00049 <span class="comment"> * R: IRQ latency test required for 16G215-01 design test</span>
00050 <span class="comment"> * M: IRQ latency test implemented</span>
00051 <span class="comment"> *</span>
00052 <span class="comment"> * Revision 1.6  2009/08/03 16:43:18  MRoth</span>
00053 <span class="comment"> * R: no support for 32 bit Z127_GPIO IP core</span>
00054 <span class="comment"> * M: a) added define Z17_MODEL_Z127</span>
00055 <span class="comment"> *    b) added Z17_MODEL_Z127 section to setstat/getstat functions</span>
00056 <span class="comment"> *</span>
00057 <span class="comment"> * Revision 1.5  2009/07/10 10:15:49  CRuff</span>
00058 <span class="comment"> * R: compiler warnings because of unused variables</span>
00059 <span class="comment"> * M: commented out the unused variables</span>
00060 <span class="comment"> *</span>
00061 <span class="comment"> * Revision 1.4  2009/04/17 10:23:38  MRoth</span>
00062 <span class="comment"> * R: no 64 Bit support</span>
00063 <span class="comment"> * M: changed set/getstat to support 64 Bit</span>
00064 <span class="comment"> *</span>
00065 <span class="comment"> * Revision 1.3  2006/12/20 11:23:21  ufranke</span>
00066 <span class="comment"> * added</span>
00067 <span class="comment"> *  + getstat code Z17_IRQ_LAST_REQUEST</span>
00068 <span class="comment"> *</span>
00069 <span class="comment"> * Revision 1.2  2006/06/01 17:03:12  cs</span>
00070 <span class="comment"> * changed ADDRSPACE_SIZE to 32 (real size is reported by Chameleon BBIS)</span>
00071 <span class="comment"> *</span>
00072 <span class="comment"> * Revision 1.1  2004/06/18 14:29:50  ub</span>
00073 <span class="comment"> * Initial Revision</span>
00074 <span class="comment"> *</span>
00075 <span class="comment"> *---------------------------------------------------------------------------</span>
00076 <span class="comment"> * (c) Copyright 2004 by MEN Mikro Elektronik GmbH, Nuernberg, Germany</span>
00077 <span class="comment"> ****************************************************************************/</span>
00078 
<a name="l00079"></a><a class="code" href="z17__drv_8c.html#a0">00079</a> <span class="preprocessor">#define _NO_LL_HANDLE        </span><span class="comment">/* ll_defs.h: don't define LL_HANDLE struct */</span>
00080 
00081 <span class="comment">/*-----------------------------------------+</span>
00082 <span class="comment">|  INCLUDES                                |</span>
00083 <span class="comment">+-----------------------------------------*/</span>
00084 <span class="preprocessor">#include &lt;MEN/men_typs.h&gt;</span>    <span class="comment">/* system dependent definitions   */</span>
00085 <span class="preprocessor">#include &lt;MEN/maccess.h&gt;</span>     <span class="comment">/* hw access macros and types     */</span>
00086 <span class="preprocessor">#include &lt;MEN/dbg.h&gt;</span>         <span class="comment">/* debug functions                */</span>
00087 <span class="preprocessor">#include &lt;MEN/oss.h&gt;</span>         <span class="comment">/* oss functions                  */</span>
00088 <span class="preprocessor">#include &lt;MEN/desc.h&gt;</span>        <span class="comment">/* descriptor functions           */</span>
00089 <span class="preprocessor">#include &lt;MEN/modcom.h&gt;</span>      <span class="comment">/* ID PROM functions              */</span>
00090 <span class="preprocessor">#include &lt;MEN/mdis_api.h&gt;</span>    <span class="comment">/* MDIS global defs               */</span>
00091 <span class="preprocessor">#include &lt;MEN/mdis_com.h&gt;</span>    <span class="comment">/* MDIS common defs               */</span>
00092 <span class="preprocessor">#include &lt;MEN/mdis_err.h&gt;</span>    <span class="comment">/* MDIS error codes               */</span>
00093 <span class="preprocessor">#include &lt;MEN/ll_defs.h&gt;</span>     <span class="comment">/* low-level driver definitions   */</span>
00094 <span class="preprocessor">#include &lt;MEN/arwen.h&gt;</span>       <span class="comment">/* definitions for Arwen GPIO     */</span>
00095 
00096 <span class="comment">/*-----------------------------------------+</span>
00097 <span class="comment">|  DEFINES                                 |</span>
00098 <span class="comment">+-----------------------------------------*/</span>
00099 <span class="comment">/* general defines */</span>
<a name="l00100"></a><a class="code" href="z17__drv_8c.html#a1">00100</a> <span class="preprocessor">#define CH_NUMBER          1          </span>
00101 <span class="preprocessor">#ifdef Z127_NOIRQ</span>
00102 <span class="preprocessor"></span><span class="preprocessor">  #define USE_IRQ            FALSE      </span>
00103 <span class="preprocessor">#else</span>
<a name="l00104"></a><a class="code" href="z17__drv_8c.html#a2">00104</a> <span class="preprocessor"></span><span class="preprocessor">  #define USE_IRQ            TRUE       </span>
00105 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
<a name="l00106"></a><a class="code" href="z17__drv_8c.html#a3">00106</a> <span class="preprocessor">#define ADDRSPACE_COUNT    1          </span>
<a name="l00107"></a><a class="code" href="z17__drv_8c.html#a4">00107</a> <span class="preprocessor">#define ADDRSPACE_SIZE     32         </span>
00109 <span class="preprocessor"></span><span class="comment">/* debug defines */</span>
<a name="l00110"></a><a class="code" href="z17__drv_8c.html#a5">00110</a> <span class="preprocessor">#define DBG_MYLEVEL        llHdl-&gt;dbgLevel    </span>
<a name="l00111"></a><a class="code" href="z17__drv_8c.html#a6">00111</a> <span class="preprocessor">#define DBH                llHdl-&gt;dbgHdl      </span>
<a name="l00112"></a><a class="code" href="z17__drv_8c.html#a7">00112</a> <span class="preprocessor">#define OSH                llHdl-&gt;osHdl       </span>
00114 <span class="preprocessor"></span><span class="comment">/* toggle mode defines */</span>
<a name="l00115"></a><a class="code" href="z17__drv_8c.html#a8">00115</a> <span class="preprocessor">#define TOG_TIME_DEFAULT   1000       </span>
<a name="l00116"></a><a class="code" href="z17__drv_8c.html#a9">00116</a> <span class="preprocessor">#define TOG_TIME_MIN       100        </span>
<a name="l00117"></a><a class="code" href="z17__drv_8c.html#a10">00117</a> <span class="preprocessor">#define TOG_TIME_MAX       60000      </span>
<a name="l00118"></a><a class="code" href="z17__drv_8c.html#a11">00118</a> <span class="preprocessor">#define TOG_CYCLIC         1          </span>
00120 <span class="preprocessor"></span><span class="comment">/* descriptor key defines*/</span>
<a name="l00121"></a><a class="code" href="z17__drv_8c.html#a12">00121</a> <span class="preprocessor">#define RESET_DEFAULT      0          </span>
<a name="l00122"></a><a class="code" href="z17__drv_8c.html#a13">00122</a> <span class="preprocessor">#define RESET_OFF          1          </span>
00124 <span class="preprocessor"></span><span class="comment">/*-----------------------------------------+</span>
00125 <span class="comment">|  TYPEDEFS                                |</span>
00126 <span class="comment">+-----------------------------------------*/</span>
00127 
<a name="l00128"></a><a class="code" href="structLL__HANDLE.html">00128</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00129     <span class="comment">/* general */</span>
<a name="l00130"></a><a class="code" href="structLL__HANDLE.html#m0">00130</a>     int32                   memAlloc;       
<a name="l00131"></a><a class="code" href="structLL__HANDLE.html#m1">00131</a>     OSS_HANDLE              *osHdl;         
<a name="l00132"></a><a class="code" href="structLL__HANDLE.html#m2">00132</a>     OSS_IRQ_HANDLE          *irqHdl;        
<a name="l00133"></a><a class="code" href="structLL__HANDLE.html#m3">00133</a>     DESC_HANDLE             *descHdl;       
<a name="l00134"></a><a class="code" href="structLL__HANDLE.html#m4">00134</a>     MACCESS                 ma;             
<a name="l00135"></a><a class="code" href="structLL__HANDLE.html#m5">00135</a>     MDIS_IDENT_FUNCT_TBL    idFuncTbl;      
00136     <span class="comment">/* debug */</span>
<a name="l00137"></a><a class="code" href="structLL__HANDLE.html#m6">00137</a>     u_int32                 dbgLevel;       
<a name="l00138"></a><a class="code" href="structLL__HANDLE.html#m7">00138</a>     DBG_HANDLE              *dbgHdl;        
00139 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00140 <span class="preprocessor"></span>    <span class="comment">/* misc */</span>
<a name="l00141"></a><a class="code" href="structLL__HANDLE.html#m8">00141</a>     OSS_SIG_HANDLE          *portChangeSig; 
<a name="l00142"></a><a class="code" href="structLL__HANDLE.html#m9">00142</a>     u_int32                 irqCount;       
<a name="l00143"></a><a class="code" href="structLL__HANDLE.html#m10">00143</a>     u_int32                 lastReq;        
00144     <span class="comment">/* IRQ latency test */</span>
<a name="l00145"></a><a class="code" href="structLL__HANDLE.html#m11">00145</a>     u_int32                 irqTest;        <span class="comment">/* test running flag (1=on) */</span>
<a name="l00146"></a><a class="code" href="structLL__HANDLE.html#m12">00146</a>     int32                   outBit;         <span class="comment">/* output bit 0..31       */</span>
<a name="l00147"></a><a class="code" href="structLL__HANDLE.html#m13">00147</a>     u_int32                 outLast;        <span class="comment">/* last set output value (1 or 0) */</span>
<a name="l00148"></a><a class="code" href="structLL__HANDLE.html#m14">00148</a>     u_int32                 irqs2fire;      <span class="comment">/* number of IRQs to fire */</span>
<a name="l00149"></a><a class="code" href="structLL__HANDLE.html#m15">00149</a>     u_int32                 startTick;      <span class="comment">/* start tick count       */</span>
<a name="l00150"></a><a class="code" href="structLL__HANDLE.html#m16">00150</a>     u_int32                 stopTick;       <span class="comment">/* stop tick count        */</span>
00151 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00152     <span class="comment">/* toggle mode */</span>
<a name="l00153"></a><a class="code" href="structLL__HANDLE.html#m17">00153</a>     OSS_ALARM_HANDLE        *alarmHdl;      
<a name="l00154"></a><a class="code" href="structLL__HANDLE.html#m18">00154</a>     OSS_SEM_HANDLE          *devSemHdl;     
<a name="l00155"></a><a class="code" href="structLL__HANDLE.html#m19">00155</a>     u_int32                 togHigh;        
<a name="l00156"></a><a class="code" href="structLL__HANDLE.html#m20">00156</a>     u_int32                 togtimeHigh;    
<a name="l00157"></a><a class="code" href="structLL__HANDLE.html#m21">00157</a>     u_int32                 togtimeLow;     
<a name="l00158"></a><a class="code" href="structLL__HANDLE.html#m22">00158</a>     u_int32                 togBitMask;     
<a name="l00159"></a><a class="code" href="structLL__HANDLE.html#m23">00159</a>     u_int32                 togCount;       
00160     <span class="comment">/* arwen no reset */</span>
<a name="l00161"></a><a class="code" href="structLL__HANDLE.html#m24">00161</a>     u_int32                 arwenResetOff;  
00162 } <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>;
00163 
00164 <span class="comment">/* include files which need LL_HANDLE */</span>
00165 <span class="preprocessor">#include &lt;MEN/ll_entry.h&gt;</span>       <span class="comment">/* low-level driver jump table */</span>
00166 <span class="preprocessor">#include &lt;<a class="code" href="z17__drv_8h.html">MEN/z17_drv.h</a>&gt;</span>        <span class="comment">/* Z17 driver header file      */</span>
00167 
00168 <span class="comment">/*-----------------------------------------+</span>
00169 <span class="comment">|  PROTOTYPES                              |</span>
00170 <span class="comment">+-----------------------------------------*/</span>
00171 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a14">Z17_Init</a>(DESC_SPEC *descSpec, OSS_HANDLE *osHdl,
00172                         MACCESS *ma, OSS_SEM_HANDLE *devSemHdl,
00173                         OSS_IRQ_HANDLE *irqHdl, <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP);
00174 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a15">Z17_Exit</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP);
00175 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a16">Z17_Read</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 *value);
00176 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a17">Z17_Write</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 value);
00177 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a18">Z17_SetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,int32 ch, int32 code,
00178                             INT32_OR_64 value32_or_64);
00179 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a19">Z17_GetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 code,
00180                             INT32_OR_64 *value32_or64P);
00181 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a20">Z17_BlockRead</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00182                             int32 *nbrRdBytesP);
00183 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a21">Z17_BlockWrite</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00184                                 int32 *nbrWrBytesP);
00185 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00186 <span class="preprocessor"></span>    <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a22">Z17_Irq</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl);
00187 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00188 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a23">Z17_Info</a>(int32 infoType, ...);
00189 <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z17__drv_8c.html#a24">Ident</a>(<span class="keywordtype">void</span>);
00190 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 retCode);
00191 <span class="keyword">static</span> <span class="keywordtype">void</span>  <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl);
00192 <span class="keyword">static</span> <span class="keywordtype">void</span>  <a class="code" href="z17__drv_8c.html#a27">arwenToggle</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl);
00193 <span class="keyword">static</span> <span class="keywordtype">void</span>  <a class="code" href="z17__drv_8c.html#a28">AlarmHandler</a>(<span class="keywordtype">void</span> *arg);
00194 
00195 <span class="comment">/****************************** Z17_GetEntry ********************************/</span>
00200 <span class="preprocessor">#ifdef _ONE_NAMESPACE_PER_DRIVER_</span>
00201 <span class="preprocessor"></span>    <span class="keyword">extern</span> <span class="keywordtype">void</span> LL_GetEntry(
00202         LL_ENTRY* drvP
00203     )
00204 #<span class="keywordflow">else</span>
<a name="l00205"></a><a class="code" href="z17__drv_8c.html#a29">00205</a>     <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="z17__drv_8h.html#a18">__Z17_GetEntry</a>(
00206         LL_ENTRY* drvP
00207     )
00208 #endif
00209 {
00210     drvP-&gt;init        = <a class="code" href="z17__drv_8c.html#a14">Z17_Init</a>;
00211     drvP-&gt;exit        = <a class="code" href="z17__drv_8c.html#a15">Z17_Exit</a>;
00212     drvP-&gt;read        = <a class="code" href="z17__drv_8c.html#a16">Z17_Read</a>;
00213     drvP-&gt;write       = <a class="code" href="z17__drv_8c.html#a17">Z17_Write</a>;
00214     drvP-&gt;blockRead   = <a class="code" href="z17__drv_8c.html#a20">Z17_BlockRead</a>;
00215     drvP-&gt;blockWrite  = <a class="code" href="z17__drv_8c.html#a21">Z17_BlockWrite</a>;
00216     drvP-&gt;setStat     = <a class="code" href="z17__drv_8c.html#a18">Z17_SetStat</a>;
00217     drvP-&gt;getStat     = <a class="code" href="z17__drv_8c.html#a19">Z17_GetStat</a>;
00218 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00219 <span class="preprocessor"></span>    drvP-&gt;irq         = <a class="code" href="z17__drv_8c.html#a22">Z17_Irq</a>;
00220 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00221     drvP-&gt;info        = <a class="code" href="z17__drv_8c.html#a23">Z17_Info</a>;
00222 }
00223 
00224 <span class="comment">/******************************** Z17_Init **********************************/</span>
<a name="l00249"></a><a class="code" href="z17__drv_8c.html#a14">00249</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a14">Z17_Init</a>(
00250     DESC_SPEC       *descP,
00251     OSS_HANDLE      *osHdl,
00252     MACCESS         *ma,
00253     OSS_SEM_HANDLE  *devSemHdl,
00254     OSS_IRQ_HANDLE  *irqHdl,
00255     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>       **llHdlP
00256 )
00257 {
00258     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = NULL;
00259     u_int32 gotsize;
00260     int32 error;
00261     u_int32 value;
00262 
00263     <span class="comment">/*------------------------------+</span>
00264 <span class="comment">    |  prepare the handle           |</span>
00265 <span class="comment">    +------------------------------*/</span>
00266     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00267 
00268     <span class="comment">/* alloc */</span>
00269     <span class="keywordflow">if</span> ((llHdl = (<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>*)OSS_MemGet(
00270                     osHdl, <span class="keyword">sizeof</span>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>), &amp;gotsize)) == NULL)
00271         <span class="keywordflow">return</span> (ERR_OSS_MEM_ALLOC);
00272 
00273     <span class="comment">/* clear */</span>
00274     OSS_MemFill(osHdl, gotsize, (<span class="keywordtype">char</span>*)llHdl, 0x00);
00275 
00276     <span class="comment">/* init */</span>
00277     llHdl-&gt;memAlloc    = gotsize;
00278     llHdl-&gt;osHdl       = osHdl;
00279 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00280 <span class="preprocessor"></span>    llHdl-&gt;irqHdl      = irqHdl;
00281 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00282     llHdl-&gt;ma          = *ma;
00283     llHdl-&gt;devSemHdl   = devSemHdl;
00284     llHdl-&gt;togtimeHigh = <a class="code" href="z17__drv_8c.html#a8">TOG_TIME_DEFAULT</a>;
00285     llHdl-&gt;togtimeLow  = <a class="code" href="z17__drv_8c.html#a8">TOG_TIME_DEFAULT</a>;
00286     llHdl-&gt;togBitMask  = 0;
00287     llHdl-&gt;togCount    = 0;
00288     llHdl-&gt;togHigh     = 0;
00289 
00290     <span class="comment">/*------------------------------+</span>
00291 <span class="comment">    |  init id function table       |</span>
00292 <span class="comment">    +------------------------------*/</span>
00293     <span class="comment">/* driver's ident function */</span>
00294     llHdl-&gt;idFuncTbl.idCall[0].identCall = <a class="code" href="z17__drv_8c.html#a24">Ident</a>;
00295     <span class="comment">/* library's ident functions */</span>
00296     llHdl-&gt;idFuncTbl.idCall[1].identCall = DESC_Ident;
00297     llHdl-&gt;idFuncTbl.idCall[2].identCall = OSS_Ident;
00298     <span class="comment">/* terminator */</span>
00299     llHdl-&gt;idFuncTbl.idCall[3].identCall = NULL;
00300 
00301     <span class="comment">/*------------------------------+</span>
00302 <span class="comment">    |  prepare debugging            |</span>
00303 <span class="comment">    +------------------------------*/</span>
00304     <a class="code" href="z17__drv_8c.html#a5">DBG_MYLEVEL</a> = OSS_DBG_DEFAULT;      <span class="comment">/* set OS specific debug level */</span>
00305     DBGINIT((NULL,&amp;<a class="code" href="z17__drv_8c.html#a6">DBH</a>));
00306 
00307     <span class="comment">/*------------------------------+</span>
00308 <span class="comment">    |  scan descriptor              |</span>
00309 <span class="comment">    +------------------------------*/</span>
00310     <span class="comment">/* prepare access */</span>
00311     <span class="keywordflow">if</span> ((error = DESC_Init(descP, osHdl, &amp;llHdl-&gt;descHdl)))
00312         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00313 
00314     <span class="comment">/* DEBUG_LEVEL_DESC */</span>
00315     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00316                                 &amp;value, <span class="stringliteral">"DEBUG_LEVEL_DESC"</span>)) &amp;&amp;
00317         error != ERR_DESC_KEY_NOTFOUND)
00318         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00319 
00320     DESC_DbgLevelSet(llHdl-&gt;descHdl, value);    <span class="comment">/* set level */</span>
00321 
00322     <span class="comment">/* DEBUG_LEVEL */</span>
00323     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00324                                 &amp;llHdl-&gt;dbgLevel, <span class="stringliteral">"DEBUG_LEVEL"</span>)) &amp;&amp;
00325         error != ERR_DESC_KEY_NOTFOUND)
00326         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00327 
00328     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Init: base address = %08p\n"</span>, (<span class="keywordtype">void</span>*)llHdl-&gt;ma));
00329 
00330     <span class="comment">/* RESET_OFF */</span>
00331     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, <a class="code" href="z17__drv_8c.html#a12">RESET_DEFAULT</a>,
00332                                 &amp;llHdl-&gt;arwenResetOff, <span class="stringliteral">"RESET_OFF"</span>)) &amp;&amp;
00333         error != ERR_DESC_KEY_NOTFOUND)
00334         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00335 
00336     <span class="comment">/*------------------------------+</span>
00337 <span class="comment">    |  init alarm                   |</span>
00338 <span class="comment">    +------------------------------*/</span>
00339     <span class="keywordflow">if</span> ((error = OSS_AlarmCreate(llHdl-&gt;osHdl, <a class="code" href="z17__drv_8c.html#a28">AlarmHandler</a>, llHdl,
00340                                     &amp;llHdl-&gt;alarmHdl)))
00341         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00342 
00343     <span class="comment">/*------------------------------+</span>
00344 <span class="comment">    |  init hardware                |</span>
00345 <span class="comment">    +------------------------------*/</span>
00346     <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(llHdl);
00347     *llHdlP = llHdl;        <span class="comment">/* set low-level driver handle */</span>
00348 
00349     <span class="keywordflow">return</span> (ERR_SUCCESS);
00350 }
00351 
00352 <span class="comment">/****************************** Z17_Exit ************************************/</span>
<a name="l00362"></a><a class="code" href="z17__drv_8c.html#a15">00362</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a15">Z17_Exit</a>(
00363     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP
00364 )
00365 {
00366     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = *llHdlP;
00367     int32 error = 0;
00368 
00369     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Exit\n"</span>));
00370 
00371     <span class="comment">/*------------------------------+</span>
00372 <span class="comment">    |  de-init hardware             |</span>
00373 <span class="comment">    +------------------------------*/</span>
00374     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m24">arwenResetOff</a> == 0)
00375         <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(llHdl);
00376     <span class="comment">/*------------------------------+</span>
00377 <span class="comment">    |  clean up memory              |</span>
00378 <span class="comment">    +------------------------------*/</span>
00379     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00380     error = <a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error);
00381 
00382     <span class="keywordflow">return</span> (error);
00383 }
00384 
00385 <span class="comment">/****************************** Z17_Read ************************************/</span>
<a name="l00396"></a><a class="code" href="z17__drv_8c.html#a16">00396</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a16">Z17_Read</a>(
00397     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>  *llHdl,
00398     int32      ch,
00399     int32      *valueP
00400 )
00401 {
00402     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Read: ch=%d\n"</span>, ch));
00403 
00404     *valueP = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_PSR);
00405 
00406     <span class="keywordflow">return</span> (ERR_SUCCESS);
00407 }
00408 
00409 <span class="comment">/****************************** Z17_Write ***********************************/</span>
<a name="l00420"></a><a class="code" href="z17__drv_8c.html#a17">00420</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a17">Z17_Write</a>(
00421     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>  *llHdl,
00422     int32      ch,
00423     int32      value
00424 )
00425 {
00426     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Write: ch=%d  val=0x%x\n"</span>, ch, value));
00427 
00428     MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_GPIO, value);
00429 
00430     <span class="keywordflow">return</span> (ERR_SUCCESS);
00431 }
00432 
00433 <span class="comment">/****************************** Z17_SetStat *********************************/</span>
<a name="l00447"></a><a class="code" href="z17__drv_8c.html#a18">00447</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a18">Z17_SetStat</a>(
00448     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>   *llHdl,
00449     int32       code,
00450     int32       ch,
00451     INT32_OR_64 value32_or_64
00452 )
00453 {
00454     int32 value = (int32)value32_or_64;     <span class="comment">/* 32bit value */</span>
00455 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00456 <span class="preprocessor"></span>    <a class="code" href="z17__drv_8h.html#a19">INT32_OR_64</a> valueP = value32_or_64;     <span class="comment">/* stores 32/64bit pointer */</span>
00457     <a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html">M_SG_BLOCK</a> *blk = (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html">M_SG_BLOCK</a>*)valueP;  <span class="comment">/* stores block struct pointer */</span>
00458 <span class="preprocessor">#endif</span>
00459 <span class="preprocessor"></span>    MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>;
00460     int32 error = ERR_SUCCESS;
00461 
00462     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_SetStat: ch=%d code=0x%04x value=0x%x\n"</span>,
00463                 ch, code, value));
00464 
00465     <span class="keywordflow">switch</span> (code) {
00466         <span class="comment">/*--------------------------+</span>
00467 <span class="comment">        |  debug level              |</span>
00468 <span class="comment">        +--------------------------*/</span>
00469         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00470             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m6">dbgLevel</a> = value;
00471             <span class="keywordflow">break</span>;
00472         <span class="comment">/*--------------------------+</span>
00473 <span class="comment">        |  enable interrupts        |</span>
00474 <span class="comment">        +--------------------------*/</span>
00475         <span class="keywordflow">case</span> M_MK_IRQ_ENABLE:
00476             <span class="keywordflow">break</span>;
00477         <span class="comment">/*--------------------------+</span>
00478 <span class="comment">        |  set irq counter          |</span>
00479 <span class="comment">        +--------------------------*/</span>
00480         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00481 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00482 <span class="preprocessor"></span>            llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m9">irqCount</a> = value;
00483 <span class="preprocessor">#endif</span>
00484 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00485         <span class="comment">/*--------------------------+</span>
00486 <span class="comment">        |  channel direction        |</span>
00487 <span class="comment">        +--------------------------*/</span>
00488         <span class="keywordflow">case</span> M_LL_CH_DIR:
00489             <span class="keywordflow">if</span> (value != M_CH_INOUT) {
00490                 error = ERR_LL_ILL_DIR;
00491             }
00492             <span class="keywordflow">break</span>;
00493         <span class="comment">/*--------------------------+</span>
00494 <span class="comment">        |  set IO ports             |</span>
00495 <span class="comment">        +--------------------------*/</span>
00496         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a0">Z17_SET_PORTS</a>:
00497             MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO) | value);
00498             <span class="comment">/* remove bit from toggle mode */</span>
00499             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>) {
00500                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a> &amp;= ~value;
00501                 <span class="comment">/* stop alarm if last bit is set */</span>
00502                 <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>)
00503                     error = OSS_AlarmClear(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>);
00504             }
00505             <span class="keywordflow">break</span>;
00506         <span class="comment">/*--------------------------+</span>
00507 <span class="comment">        |  clear IO ports           |</span>
00508 <span class="comment">        +--------------------------*/</span>
00509         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a1">Z17_CLR_PORTS</a>:
00510             MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO) &amp; ~value);
00511             <span class="comment">/* remove bit from toggle mode */</span>
00512             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>) {
00513                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a> &amp;= ~value;
00514                 <span class="comment">/* stop alarm if last bit is cleared */</span>
00515                 <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>)
00516                     error = OSS_AlarmClear(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>);
00517             }
00518             <span class="keywordflow">break</span>;
00519         <span class="comment">/*--------------------------+</span>
00520 <span class="comment">        |  port direction           |</span>
00521 <span class="comment">        +--------------------------*/</span>
00522         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a2">Z17_DIRECTION</a>:
00523             MWRITE_D32(ma, ARWEN_DDR, value);
00524             <span class="keywordflow">break</span>;
00525 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00526 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00527 <span class="comment">        |  edge for interrupt       |</span>
00528 <span class="comment">        +--------------------------*/</span>
00529         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a3">Z17_IRQ_SENSE</a>:
00530 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00531 <span class="preprocessor"></span>        <span class="comment">/* Z34/Z37 - 8 GPIOs */</span>
00532             MWRITE_D32(ma, ARWEN_02_IER1, value &amp; 0xff);
00533             MWRITE_D32(ma, ARWEN_02_IER2, (value &gt;&gt; 8) &amp; 0xff);
00534             <span class="keywordflow">break</span>;
00535 <span class="preprocessor">#else</span>
00536 <span class="preprocessor"></span>        <span class="comment">/* Z127: GPIOs 0..15 - two bits per GPIO */</span>
00537             MWRITE_D32(ma, ARWEN_02_IER1, value);
00538             <span class="keywordflow">break</span>;
00539         <span class="comment">/* Z127: GPIOs 16..31 - two bits per GPIO */</span>
00540         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a9">Z17_IRQ_SENSE_16TO31</a>:
00541             MWRITE_D32(ma, ARWEN_02_IER2, value);
00542             <span class="keywordflow">break</span>;
00543 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00544 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00545         <span class="comment">/*--------------------------+</span>
00546 <span class="comment">        |  open drain               |</span>
00547 <span class="comment">        +--------------------------*/</span>
00548         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a4">Z17_OPEN_DRAIN</a>:
00549             MWRITE_D32(ma, ARWEN_02_ODER, value);
00550             <span class="keywordflow">break</span>;
00551         <span class="comment">/*--------------------------+</span>
00552 <span class="comment">        |  debouncer                |</span>
00553 <span class="comment">        +--------------------------*/</span>
00554         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a5">Z17_DEBOUNCE</a>:
00555             MWRITE_D32(ma, ARWEN_02_DBER, value);
00556             <span class="keywordflow">break</span>;
00557 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00558 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00559 <span class="comment">        |  register signal          |</span>
00560 <span class="comment">        +--------------------------*/</span>
00561         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a6">Z17_SET_SIGNAL</a>:
00562             <span class="comment">/* signal already installed ? */</span>
00563             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a>) {
00564                 error = ERR_OSS_SIG_SET;
00565                 <span class="keywordflow">break</span>;
00566             }
00567             error = OSS_SigCreate(<a class="code" href="z17__drv_8c.html#a7">OSH</a>, value, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a>);
00568             <span class="keywordflow">break</span>;
00569         <span class="comment">/*--------------------------+</span>
00570 <span class="comment">        |  unregister signal        |</span>
00571 <span class="comment">        +--------------------------*/</span>
00572         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a7">Z17_CLR_SIGNAL</a>:
00573             <span class="comment">/* signal already installed ? */</span>
00574             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a> == NULL) {
00575                 error = ERR_OSS_SIG_CLR;
00576                 <span class="keywordflow">break</span>;
00577             }
00578             error = OSS_SigRemove(<a class="code" href="z17__drv_8c.html#a7">OSH</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a>);
00579             <span class="keywordflow">break</span>;
00580         <span class="comment">/*--------------------------+</span>
00581 <span class="comment">        |  init IRQ latency test    |</span>
00582 <span class="comment">        +--------------------------*/</span>
00583         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a13">Z17_BLK_IRQLAT_START</a>:
00584         {
00585             int32 value;
00586             <a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a> *irqlat = (<a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a>*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#m1">data</a>;
00587 
00588             <span class="comment">/* clear out values */</span>
00589             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m4">startTick</a> = 0;
00590             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m5">stopTick</a> = 0;
00591             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m6">irqsRcved</a> = 0;
00592 
00593             <span class="comment">/* init */</span>
00594             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m11">irqTest</a> = 1;
00595             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m14">irqs2fire</a> = irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m2">irqs2fire</a>-1;
00596             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m9">irqCount</a> = 0;
00597             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m16">stopTick</a> = 0;
00598 
00599             <span class="comment">/* compute and save output bit */</span>
00600             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m12">outBit</a> = 1 &lt;&lt; irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m0">outPort</a>;
00601 
00602             <span class="comment">/* disable all interrupts */</span>
00603             MWRITE_D32(ma, ARWEN_02_IER1, 0);
00604             MWRITE_D32(ma, ARWEN_02_IER2, 0);
00605 
00606             <span class="comment">/* program all ports as inputs */</span>
00607             MWRITE_D32(ma, ARWEN_DDR, 0);
00608 
00609             <span class="comment">/* determine actual state of output port */</span>
00610             value = MREAD_D32(ma, ARWEN_02_PSR);
00611             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a> = (value &amp; llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m12">outBit</a>) ? 1 : 0;
00612 
00613             <span class="comment">/* preset output port value */</span>
00614             MWRITE_D32(ma, ARWEN_GPIO, value);
00615 
00616             <span class="comment">/* enable IRQ for rising+falling edge of input port */</span>
00617 <span class="comment">/* Z34/Z37 - 8 GPIOs */</span>
00618 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00619 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a> &lt; 4) <span class="comment">/* port 3..0 */</span>
00620                 MWRITE_D32(ma, ARWEN_02_IER1, 3 &lt;&lt; (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a> * 2));
00621             <span class="keywordflow">else</span>    <span class="comment">/* port 8..4 */</span>
00622                 MWRITE_D32(ma, ARWEN_02_IER2, 3 &lt;&lt; ((irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a>-4) * 2));
00623 <span class="comment">/* Z127 - 32 GPIOs */</span>
00624 <span class="preprocessor">#else</span>
00625 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a> &lt; 16)    <span class="comment">/* port 15..0 */</span>
00626                 MWRITE_D32(ma, ARWEN_02_IER1, 3 &lt;&lt; (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a> * 2));
00627             <span class="keywordflow">else</span>    <span class="comment">/* port 32..16 */</span>
00628                 MWRITE_D32(ma, ARWEN_02_IER2, 3 &lt;&lt; ((irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m1">inPort</a>-16) * 2));
00629 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00630             <span class="comment">/* config port as output (default is input) */</span>
00631             MWRITE_D32(ma, ARWEN_DDR, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m12">outBit</a>);
00632 
00633             <span class="comment">/* set output (this fires the first IRQ) */</span>
00634             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a> = !llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a>;
00635             DBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"set output=0x%x, irqs2fire=%d\n"</span>,
00636                         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m14">irqs2fire</a>));
00637             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m15">startTick</a> = OSS_TickGet(<a class="code" href="z17__drv_8c.html#a7">OSH</a>);
00638             MWRITE_D32(ma, ARWEN_GPIO, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a> ? llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m12">outBit</a> : 0);
00639             <span class="keywordflow">break</span>;
00640         }
00641 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00642         <span class="comment">/*--------------------------+</span>
00643 <span class="comment">        |  Toggle mode              |</span>
00644 <span class="comment">        +--------------------------*/</span>
00645         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a10">Z17_TOG_PORTS</a>:
00646         {
00647             u_int32 realMsec;
00648 
00649             <span class="comment">/* start timer initially */</span>
00650             <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>) {
00651                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a> = value;
00652                 error = OSS_AlarmSet(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>,
00653                                         <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>, <a class="code" href="z17__drv_8c.html#a11">TOG_CYCLIC</a>, &amp;realMsec);
00654             } <span class="keywordflow">else</span> {
00655                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a> |= value;
00656                 <span class="comment">/* reset timer */</span>
00657                 error = OSS_AlarmClear(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>);
00658                 error = OSS_AlarmSet(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>,
00659                                         <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>, <a class="code" href="z17__drv_8c.html#a11">TOG_CYCLIC</a>, &amp;realMsec);
00660             }
00661             <span class="keywordflow">break</span>;
00662         }
00663         <span class="comment">/*--------------------------+</span>
00664 <span class="comment">        |  Toggle mode - high       |</span>
00665 <span class="comment">        +--------------------------*/</span>
00666         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a11">Z17_TOG_HIGH</a>:
00667             <span class="comment">/* adjust time value (100ms resolution) */</span>
00668             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> = (value / <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>) * <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00669             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> &gt; <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>)
00670                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> = <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>;
00671             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> &lt; <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>)
00672                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> = <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00673             <span class="keywordflow">break</span>;
00674         <span class="comment">/*--------------------------+</span>
00675 <span class="comment">        |  Toggle mode - low        |</span>
00676 <span class="comment">        +--------------------------*/</span>
00677         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a12">Z17_TOG_LOW</a>:
00678             <span class="comment">/* adjust time value (100ms resolution) */</span>
00679             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a> = (value / <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>) * <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00680             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a> &gt; <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>)
00681                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a> = <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>;
00682             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a> &lt; <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>)
00683                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a> = <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00684             <span class="keywordflow">break</span>;
00685         <span class="comment">/*--------------------------+</span>
00686 <span class="comment">        |  (unknown)                |</span>
00687 <span class="comment">        +--------------------------*/</span>
00688         <span class="keywordflow">default</span>:
00689             error = ERR_LL_UNK_CODE;
00690     }
00691 
00692     <span class="keywordflow">return</span> (error);
00693 }
00694 
00695 <span class="comment">/****************************** Z17_GetStat *********************************/</span>
<a name="l00712"></a><a class="code" href="z17__drv_8c.html#a19">00712</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a19">Z17_GetStat</a>(
00713     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>   *llHdl,
00714     int32       code,
00715     int32       ch,
00716     INT32_OR_64 *value32_or_64P
00717 )
00718 {
00719     int32 *valueP = (int32*)value32_or_64P;     <span class="comment">/* pointer to 32bit value */</span>
00720     <a class="code" href="z17__drv_8h.html#a19">INT32_OR_64</a> *value64P = value32_or_64P;     <span class="comment">/* stores 32/64bit pointer */</span>
00721     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>;
00722     int32 error = ERR_SUCCESS;
00723 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00724 <span class="preprocessor"></span>    <a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html">M_SG_BLOCK</a> *blk = (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html">M_SG_BLOCK</a>*)value32_or_64P;  <span class="comment">/* stores block struct pointer; not needed here */</span>
00725     OSS_IRQ_STATE irqState;
00726 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00727 
00728     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_GetStat: ch=%d code=0x%04x\n"</span>, ch, code));
00729 
00730     <span class="keywordflow">switch</span> (code) {
00731         <span class="comment">/*--------------------------+</span>
00732 <span class="comment">        |  debug level              |</span>
00733 <span class="comment">        +--------------------------*/</span>
00734         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00735             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m6">dbgLevel</a>;
00736             <span class="keywordflow">break</span>;
00737         <span class="comment">/*--------------------------+</span>
00738 <span class="comment">        |  number of channels       |</span>
00739 <span class="comment">        +--------------------------*/</span>
00740         <span class="keywordflow">case</span> M_LL_CH_NUMBER:
00741             *valueP = <a class="code" href="z17__drv_8c.html#a1">CH_NUMBER</a>;
00742             <span class="keywordflow">break</span>;
00743         <span class="comment">/*--------------------------+</span>
00744 <span class="comment">        |  channel direction        |</span>
00745 <span class="comment">        +--------------------------*/</span>
00746         <span class="keywordflow">case</span> M_LL_CH_DIR:
00747             *valueP = M_CH_INOUT;
00748             <span class="keywordflow">break</span>;
00749         <span class="comment">/*--------------------------+</span>
00750 <span class="comment">        |  channel length [bits]    |</span>
00751 <span class="comment">        +--------------------------*/</span>
00752         <span class="keywordflow">case</span> M_LL_CH_LEN:
00753 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00754 <span class="preprocessor"></span>            <span class="comment">/* Z34 / Z37 */</span>
00755             *valueP = 8;
00756             <span class="keywordflow">break</span>;
00757 <span class="preprocessor">#else</span>
00758 <span class="preprocessor"></span>            <span class="comment">/* Z127 */</span>
00759             *valueP = 32;
00760             <span class="keywordflow">break</span>;
00761 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00762         <span class="comment">/*--------------------------+</span>
00763 <span class="comment">        |  channel type info        |</span>
00764 <span class="comment">        +--------------------------*/</span>
00765         <span class="keywordflow">case</span> M_LL_CH_TYP:
00766             *valueP = M_CH_BINARY;
00767             <span class="keywordflow">break</span>;
00768         <span class="comment">/*--------------------------+</span>
00769 <span class="comment">        |  irq counter              |</span>
00770 <span class="comment">        +--------------------------*/</span>
00771         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00772 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00773 <span class="preprocessor"></span>            *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m9">irqCount</a>;
00774 <span class="preprocessor">#endif</span>
00775 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00776         <span class="comment">/*--------------------------+</span>
00777 <span class="comment">        |  ID PROM check enabled    |</span>
00778 <span class="comment">        +--------------------------*/</span>
00779         <span class="keywordflow">case</span> M_LL_ID_CHECK:
00780             *valueP = 0;
00781             <span class="keywordflow">break</span>;
00782         <span class="comment">/*--------------------------+</span>
00783 <span class="comment">        |  ident table pointer      |</span>
00784 <span class="comment">        |  (treat as non-block!)    |</span>
00785 <span class="comment">        +--------------------------*/</span>
00786         <span class="keywordflow">case</span> M_MK_BLK_REV_ID:
00787             *value64P = (INT32_OR_64)&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m5">idFuncTbl</a>;
00788             <span class="keywordflow">break</span>;
00789         <span class="comment">/*--------------------------+</span>
00790 <span class="comment">        |  port direction           |</span>
00791 <span class="comment">        +--------------------------*/</span>
00792         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a2">Z17_DIRECTION</a>:
00793             *valueP = MREAD_D32(ma, ARWEN_DDR);
00794             <span class="keywordflow">break</span>;
00795 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00796 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00797 <span class="comment">        |  edge for interrupt       |</span>
00798 <span class="comment">        +--------------------------*/</span>
00799         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a3">Z17_IRQ_SENSE</a>:
00800 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00801 <span class="preprocessor"></span>            <span class="comment">/* Z34/Z37 */</span>
00802             *valueP = MREAD_D32(ma, ARWEN_02_IER1) |
00803                         MREAD_D32(ma, ARWEN_02_IER2) &lt;&lt; 8;
00804             <span class="keywordflow">break</span>;
00805 <span class="preprocessor">#else</span>
00806 <span class="preprocessor"></span>            <span class="comment">/* Z127: GPIOs 0..15 - two bits per GPIO */</span>
00807             *valueP = MREAD_D32(ma, ARWEN_02_IER1);
00808             <span class="keywordflow">break</span>;
00809         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a9">Z17_IRQ_SENSE_16TO31</a>:
00810             <span class="comment">/* Z127: GPIOs 16..31 - two bits per GPIO */</span>
00811             *valueP = MREAD_D32(ma, ARWEN_02_IER2);
00812             <span class="keywordflow">break</span>;
00813 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00814 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00815         <span class="comment">/*--------------------------+</span>
00816 <span class="comment">        |  open drain               |</span>
00817 <span class="comment">        +--------------------------*/</span>
00818         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a4">Z17_OPEN_DRAIN</a>:
00819             *valueP = MREAD_D32(ma, ARWEN_02_ODER);
00820             <span class="keywordflow">break</span>;
00821         <span class="comment">/*--------------------------+</span>
00822 <span class="comment">        |  debouncer                |</span>
00823 <span class="comment">        +--------------------------*/</span>
00824         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a5">Z17_DEBOUNCE</a>:
00825             *valueP = MREAD_D32(ma, ARWEN_02_DBER);
00826             <span class="keywordflow">break</span>;
00827 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00828 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00829 <span class="comment">        |  last IRQ request         |</span>
00830 <span class="comment">        +--------------------------*/</span>
00831         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a8">Z17_IRQ_LAST_REQUEST</a>:
00832             irqState = OSS_IrqMaskR(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m2">irqHdl</a>);
00833             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m10">lastReq</a>;
00834             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m10">lastReq</a> = 0;
00835             OSS_IrqRestore(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m2">irqHdl</a>, irqState);
00836             <span class="keywordflow">break</span>;
00837         <span class="comment">/*--------------------------+</span>
00838 <span class="comment">        |  IRQ latency test result  |</span>
00839 <span class="comment">        +--------------------------*/</span>
00840         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a14">Z17_BLK_IRQLAT_RESULT</a>:
00841         {
00842             <a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a> *irqlat = (<a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a>*)blk-&gt;<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#m1">data</a>;
00843 
00844             <span class="comment">/* IRQ latency test not started? */</span>
00845             <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m11">irqTest</a>) {
00846                 error = ERR_LL_DEV_NOTRDY;
00847                 <span class="keywordflow">break</span>;
00848             }
00849             <span class="comment">/* IRQ latency test not yet finished? */</span>
00850             <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m16">stopTick</a>) {
00851                 error = ERR_LL_DEV_BUSY;
00852                 <span class="keywordflow">break</span>;
00853             }
00854             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m11">irqTest</a> = 0;
00855 
00856             <span class="comment">/* disable all IRQs */</span>
00857             MWRITE_D32(ma, ARWEN_02_IER1, 0);
00858             MWRITE_D32(ma, ARWEN_02_IER2, 0);
00859 
00860             <span class="comment">/* reset all outputs */</span>
00861             MWRITE_D32(ma, ARWEN_GPIO, 0);
00862 
00863             <span class="comment">/* program all ports as inputs */</span>
00864             MWRITE_D32(ma, ARWEN_DDR, 0);
00865 
00866             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m3">tickRate</a> = OSS_TickRateGet(<a class="code" href="z17__drv_8c.html#a7">OSH</a>);
00867             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m4">startTick</a> = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m15">startTick</a>;
00868             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m5">stopTick</a> = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m16">stopTick</a>;
00869             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#m6">irqsRcved</a> = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m9">irqCount</a>;
00870             <span class="keywordflow">break</span>;
00871         }
00872 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00873         <span class="comment">/*--------------------------+</span>
00874 <span class="comment">        |  (unknown)                |</span>
00875 <span class="comment">        +--------------------------*/</span>
00876         <span class="keywordflow">default</span>:
00877             error = ERR_LL_UNK_CODE;
00878     }
00879 
00880     <span class="keywordflow">return</span> (error);
00881 }
00882 
00883 <span class="comment">/******************************* Z17_BlockRead ******************************/</span>
<a name="l00894"></a><a class="code" href="z17__drv_8c.html#a20">00894</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a20">Z17_BlockRead</a>(
00895     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00896     int32     ch,
00897     <span class="keywordtype">void</span>      *buf,
00898     int32     size,
00899     int32     *nbrRdBytesP
00900 )
00901 {
00902     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_BlockRead: ch=%d, size=%d\n"</span>, ch, size));
00903 
00904     <span class="comment">/* return number of read bytes */</span>
00905     *nbrRdBytesP = 0;
00906 
00907     <span class="keywordflow">return</span> (ERR_LL_ILL_FUNC);
00908 }
00909 
00910 <span class="comment">/****************************** Z17_BlockWrite *****************************/</span>
<a name="l00921"></a><a class="code" href="z17__drv_8c.html#a21">00921</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a21">Z17_BlockWrite</a>(
00922     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00923     int32     ch,
00924     <span class="keywordtype">void</span>      *buf,
00925     int32     size,
00926     int32     *nbrWrBytesP
00927 )
00928 {
00929     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_BlockWrite: ch=%d, size=%d\n"</span>, ch, size));
00930 
00931     <span class="comment">/* return number of written bytes */</span>
00932     *nbrWrBytesP = 0;
00933 
00934     <span class="keywordflow">return</span> (ERR_LL_ILL_FUNC);
00935 }
00936 
00937 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00938 <span class="preprocessor"></span><span class="comment">/****************************** Z17_Irq ************************************/</span>
<a name="l00957"></a><a class="code" href="z17__drv_8c.html#a22">00957</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a22">Z17_Irq</a>(
00958     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl
00959 )
00960 {
00961     u_int32 irqReq;
00962     u_int32 ier1, ier2;
00963 
00964     <span class="comment">/* interrupt caused by Arwen ? */</span>
00965     irqReq = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_IRR);
00966 
00967     IDBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; LL - Z17_Irq: request %08x\n"</span>, irqReq));
00968     
00969     <span class="keywordflow">if</span> (irqReq) {
00970 
00971         <span class="comment">/* save IERs */</span>
00972         ier1 = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER1);
00973         ier2 = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER2);
00974         <span class="comment">/* disable all IRQs (for MSI(x)) */</span>
00975         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER1, 0);
00976         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER2, 0);
00977 
00978         <span class="comment">/* clear interrupt */</span>
00979         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_IRR, irqReq);
00980         
00981         <span class="comment">/* if requested send signal to application */</span>
00982         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a>)
00983             OSS_SigSend(<a class="code" href="z17__drv_8c.html#a7">OSH</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m8">portChangeSig</a>);
00984         
00985         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m9">irqCount</a>++;
00986         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m10">lastReq</a> = irqReq;
00987         
00988         <span class="comment">/* IRQ latency test */</span>
00989         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m11">irqTest</a>) {
00990             <span class="comment">/* pending IRQs to fire? */</span>
00991             IDBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; Z17_Irq: irqs2fire=%d\n"</span>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m14">irqs2fire</a>));
00992             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m14">irqs2fire</a>) {
00993                 <span class="comment">/* set output (this fires the next IRQ) */</span>
00994                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a> = !llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a>;
00995                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m14">irqs2fire</a>--;
00996                 IDBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; Z17_Irq: set output 0x%x\n"</span>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a>));
00997                 MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_GPIO, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m13">outLast</a> ? llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m12">outBit</a> : 0);
00998             } <span class="keywordflow">else</span> {
00999                 <span class="comment">/* this was the last IRQ */</span>
01000                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m16">stopTick</a> = OSS_TickGet(<a class="code" href="z17__drv_8c.html#a7">OSH</a>);
01001             }
01002         }<span class="comment">/* IRQ latency test */</span>
01003         
01004         <span class="comment">/* enable all IRQs (for MSI(x)) */</span>
01005         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER1, ier1);
01006         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>, ARWEN_02_IER2, ier2);
01007 
01008         <span class="keywordflow">return</span> (LL_IRQ_DEVICE);
01009     }
01010 
01011     <span class="keywordflow">return</span> (LL_IRQ_DEV_NOT);
01012 }
01013 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
01014 
01015 <span class="comment">/****************************** Z17_Info ***********************************/</span>
<a name="l01053"></a><a class="code" href="z17__drv_8c.html#a23">01053</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a23">Z17_Info</a>(
01054     int32 infoType,
01055     ...
01056 )
01057 {
01058     int32   error = ERR_SUCCESS;
01059     va_list argptr;
01060 
01061     va_start(argptr, infoType);
01062 
01063     <span class="keywordflow">switch</span> (infoType) {
01064         <span class="comment">/*-------------------------------+</span>
01065 <span class="comment">        |  hardware characteristics      |</span>
01066 <span class="comment">        |  (all addr/data modes ORed)    |</span>
01067 <span class="comment">        +-------------------------------*/</span>
01068         <span class="keywordflow">case</span> LL_INFO_HW_CHARACTER:
01069         {
01070             u_int32 *addrModeP = va_arg(argptr, u_int32*);
01071             u_int32 *dataModeP = va_arg(argptr, u_int32*);
01072         
01073             *addrModeP = MDIS_MA08;
01074             *dataModeP = MDIS_MD08 | MDIS_MD16;
01075             <span class="keywordflow">break</span>;
01076         }
01077         <span class="comment">/*-------------------------------+</span>
01078 <span class="comment">        |  nr of required address spaces |</span>
01079 <span class="comment">        |  (total spaces used)           |</span>
01080 <span class="comment">        +-------------------------------*/</span>
01081         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE_COUNT:
01082         {
01083             u_int32 *nbrOfAddrSpaceP = va_arg(argptr, u_int32*);
01084         
01085             *nbrOfAddrSpaceP = <a class="code" href="z17__drv_8c.html#a3">ADDRSPACE_COUNT</a>;
01086             <span class="keywordflow">break</span>;
01087         }
01088         <span class="comment">/*-------------------------------+</span>
01089 <span class="comment">        |  address space type            |</span>
01090 <span class="comment">        |  (widest used data mode)       |</span>
01091 <span class="comment">        +-------------------------------*/</span>
01092         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE:
01093         {
01094             u_int32 addrSpaceIndex = va_arg(argptr, u_int32);
01095             u_int32 *addrModeP = va_arg(argptr, u_int32*);
01096             u_int32 *dataModeP = va_arg(argptr, u_int32*);
01097             u_int32 *addrSizeP = va_arg(argptr, u_int32*);
01098         
01099             <span class="keywordflow">if</span> (addrSpaceIndex &gt;= <a class="code" href="z17__drv_8c.html#a3">ADDRSPACE_COUNT</a>) {
01100                 error = ERR_LL_ILL_PARAM;
01101             } <span class="keywordflow">else</span> {
01102                 *addrModeP = MDIS_MA08;
01103                 *dataModeP = MDIS_MD16;
01104                 *addrSizeP = <a class="code" href="z17__drv_8c.html#a4">ADDRSPACE_SIZE</a>;
01105             }
01106             <span class="keywordflow">break</span>;
01107         }
01108         <span class="comment">/*-------------------------------+</span>
01109 <span class="comment">        |  interrupt required            |</span>
01110 <span class="comment">        +-------------------------------*/</span>
01111         <span class="keywordflow">case</span> LL_INFO_IRQ:
01112         {
01113             u_int32 *useIrqP = va_arg(argptr, u_int32*);
01114 
01115             *useIrqP = <a class="code" href="z17__drv_8c.html#a2">USE_IRQ</a>;
01116             <span class="keywordflow">break</span>;
01117         }
01118         <span class="comment">/*-------------------------------+</span>
01119 <span class="comment">        |  process lock mode             |</span>
01120 <span class="comment">        +-------------------------------*/</span>
01121         <span class="keywordflow">case</span> LL_INFO_LOCKMODE:
01122         {
01123             u_int32 *lockModeP = va_arg(argptr, u_int32*);
01124 
01125             *lockModeP = LL_LOCK_CALL;
01126             <span class="keywordflow">break</span>;
01127         }
01128         <span class="comment">/*-------------------------------+</span>
01129 <span class="comment">        |  (unknown)                     |</span>
01130 <span class="comment">        +-------------------------------*/</span>
01131         <span class="keywordflow">default</span>:
01132             error = ERR_LL_ILL_PARAM;
01133     }
01134 
01135     va_end(argptr);
01136 
01137     <span class="keywordflow">return</span> (error);
01138 }
01139 
01140 <span class="comment">/******************************** Ident ************************************/</span>
<a name="l01145"></a><a class="code" href="z17__drv_8c.html#a24">01145</a> <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z17__drv_8c.html#a24">Ident</a>(<span class="keywordtype">void</span>)
01146 {
01147     <span class="keywordflow">return</span> (<span class="stringliteral">"Z17 - Z17 low level driver: $Id: z17_drv.c,v 1.11 2014/11/28 14:17:37 MRoth Exp $"</span>
01148 <span class="preprocessor">            #ifdef Z17_MODEL_Z127</span>
01149 <span class="preprocessor"></span>                <span class="stringliteral">" Z127 model"</span>
01150 <span class="preprocessor">            #else</span>
01151 <span class="preprocessor"></span>                <span class="stringliteral">" Z34/Z37 model"</span>
01152 <span class="preprocessor">            #endif</span>
01153 <span class="preprocessor"></span><span class="preprocessor">            #ifdef Z127_NOIRQ</span>
01154 <span class="preprocessor"></span>                <span class="stringliteral">" - no IRQs"</span>
01155 <span class="preprocessor">            #endif</span>
01156 <span class="preprocessor"></span>            );
01157 }
01158 
01159 <span class="comment">/********************************* Cleanup *********************************/</span>
<a name="l01169"></a><a class="code" href="z17__drv_8c.html#a25">01169</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(
01170     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
01171     int32     retCode
01172 )
01173 {
01174     <span class="comment">/*------------------------------+</span>
01175 <span class="comment">    |  close handles                |</span>
01176 <span class="comment">    +------------------------------*/</span>
01177     <span class="comment">/* clean up desc */</span>
01178     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m3">descHdl</a>)
01179         DESC_Exit(&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m3">descHdl</a>);
01180 
01181     <span class="comment">/* clean up alarm */</span>
01182     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>)
01183         OSS_AlarmRemove(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m17">alarmHdl</a>);
01184 
01185     <span class="comment">/* clean up debug */</span>
01186     DBGEXIT((&amp;<a class="code" href="z17__drv_8c.html#a6">DBH</a>));
01187 
01188     <span class="comment">/*------------------------------+</span>
01189 <span class="comment">    |  free memory                  |</span>
01190 <span class="comment">    +------------------------------*/</span>
01191     <span class="comment">/* free my handle */</span>
01192     OSS_MemFree(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, (int8*)llHdl, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m0">memAlloc</a>);
01193 
01194     <span class="comment">/*return error code */</span>
01195     <span class="keywordflow">return</span> (retCode);
01196 }
01197 
01198 <span class="comment">/******************************* arwenReset ********************************/</span>
<a name="l01208"></a><a class="code" href="z17__drv_8c.html#a26">01208</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(
01209     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl
01210 )
01211 {
01212     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>;
01213 
01214     <span class="comment">/* disable all interrupts */</span>
01215     MWRITE_D32(ma, ARWEN_02_IER1, 0);
01216     MWRITE_D32(ma, ARWEN_02_IER2, 0);
01217 
01218     <span class="comment">/* program all ports as inputs */</span>
01219     MWRITE_D32(ma, ARWEN_DDR, 0);
01220 
01221     <span class="comment">/* disable open drain and debouncer */</span>
01222     MWRITE_D32(ma, ARWEN_02_ODER, 0);
01223     MWRITE_D32(ma, ARWEN_02_DBER, 0);
01224 }
01225 
01226 <span class="comment">/******************************* AlarmHandler ******************************/</span>
<a name="l01233"></a><a class="code" href="z17__drv_8c.html#a28">01233</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z17__drv_8c.html#a28">AlarmHandler</a>(
01234     <span class="keywordtype">void</span> *arg
01235 )
01236 {
01237     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = (<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>*)arg;
01238     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m4">ma</a>;
01239 
01240     DBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; LL - Z17_Z127 AlarmHandler:\n"</span>));
01241 
01242     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m23">togCount</a> += <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
01243 
01244     <span class="comment">/* reset counter */</span>
01245     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m23">togCount</a> &gt; ((llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a> + llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m21">togtimeLow</a>)))
01246         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m23">togCount</a> = 0;
01247 
01248     <span class="comment">/* toggle high */</span>
01249     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m19">togHigh</a> &amp;&amp; (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m23">togCount</a> &lt;= (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a>))) {
01250 
01251         <span class="comment">/* lock device */</span>
01252         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>)
01253             OSS_SemWait(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>, OSS_SEM_WAITFOREVER);
01254 
01255         MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO)
01256                                     | llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>);
01257 
01258         <span class="comment">/* release device (for other processes) */</span>
01259         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>)
01260             OSS_SemSignal(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>);
01261 
01262         <span class="comment">/* reset flag */</span>
01263         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m19">togHigh</a> = 0;
01264     }
01265 
01266     <span class="comment">/* toggle low */</span>
01267     <span class="keywordflow">if</span> ((!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m19">togHigh</a>) &amp;&amp; (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m23">togCount</a> &gt; (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m20">togtimeHigh</a>))) {
01268 
01269         <span class="comment">/* lock device */</span>
01270         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>)
01271             OSS_SemWait(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>, OSS_SEM_WAITFOREVER);
01272 
01273         MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO)
01274                                     &amp; ~(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m22">togBitMask</a>));
01275 
01276         <span class="comment">/* release device (for other processes) */</span>
01277         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>)
01278             OSS_SemSignal(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m18">devSemHdl</a>);
01279 
01280         <span class="comment">/* reset flag */</span>
01281         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#m19">togHigh</a> = 1;
01282     }
01283 }
</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for Z17 MDIS Driver using <a href="http://www.doxygen.org">doxygen</a>.<br>
	Copyright &copy; 2014 <a href="http://www.men.de">MEN Mikro Elektronik GmbH</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

