<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - Z17 MDIS Driver - z17_drv.c Source File</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;"></a>
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">Z17 MDIS Driver &nbsp; </h1>
	<h3>z17_drv.c Source File</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>z17_drv.c</h1><a href="z17__drv_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*********************  P r o g r a m  -  M o d u l e ***********************/</span>
00018  <span class="comment">/*-------------------------------[ History ]--------------------------------</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> * $Log: z17_drv.c,v $</span>
00021 <span class="comment"> * Revision 1.12  2016/07/13 10:09:33  ts</span>
00022 <span class="comment"> * R: m_open failed on EM10A00 GPIOs with 0x20 address space size.</span>
00023 <span class="comment"> * M: previous default ADDRSPACE_SIZE of 0x100 failed to match, corrected back to 0x20.</span>
00024 <span class="comment"> *    (corrected in next commit)    </span>
00025 <span class="comment"> *</span>
00026 <span class="comment"> * Revision 1.11  2014/11/28 14:17:37  MRoth</span>
00027 <span class="comment"> * R: 1.) no toggle function for GPIOs</span>
00028 <span class="comment"> *    2.) Z127 variant always requested an IRQ even if it had none in Hardware</span>
00029 <span class="comment"> *    3.) no support for MSI(x) - no IRQ should happen during ISR</span>
00030 <span class="comment"> *    4.) GPIO reset at driver exit (m_close) not always wanted</span>
00031 <span class="comment"> *    5.) cosmetics</span>
00032 <span class="comment"> * M: 1.a) added setstats Z17_TOG_PORTS, Z17_TOG_HIGH, Z17_TOG_LOW</span>
00033 <span class="comment"> *      b) added AlarmHandler() for timer</span>
00034 <span class="comment"> *    2.) introduced Z127_NOIRQ variant to inhibit IRQs.</span>
00035 <span class="comment"> *    3.) disable IRQs at the beginning and re-enable at the end of the ISR</span>
00036 <span class="comment"> *    4.) added RESET_OFF descriptor key to init function</span>
00037 <span class="comment"> *    5.) revised code completely</span>
00038 <span class="comment"> *</span>
00039 <span class="comment"> * Revision 1.10  2011/11/16 15:24:31  GLeonhardt</span>
00040 <span class="comment"> * R: 1.) Interrupts for GPIO 4-7 did not work with Z34/Z37 core</span>
00041 <span class="comment"> *        A preprocessor string comparison did not work.</span>
00042 <span class="comment"> *        Driver always compiled as Z127 model with 32 bit registers.</span>
00043 <span class="comment"> * M: 1.) Replace string comparison with driver switch from Makefile.</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> * Revision 1.9  2011/09/12 13:51:23  GLeonhardt</span>
00046 <span class="comment"> * R: Compiler error, if MWRITE_D32 macro is a compound statement</span>
00047 <span class="comment"> * M: Embed macro in braces</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> * Revision 1.8  2011/07/27 15:17:49  dpfeuffer</span>
00050 <span class="comment"> * R: IRQ latency test initialization problem</span>
00051 <span class="comment"> * M: IRQ latency test initialization revised</span>
00052 <span class="comment"> *</span>
00053 <span class="comment"> * Revision 1.7  2011/07/08 13:20:09  dpfeuffer</span>
00054 <span class="comment"> * R: IRQ latency test required for 16G215-01 design test</span>
00055 <span class="comment"> * M: IRQ latency test implemented</span>
00056 <span class="comment"> *</span>
00057 <span class="comment"> * Revision 1.6  2009/08/03 16:43:18  MRoth</span>
00058 <span class="comment"> * R: no support for 32 bit Z127_GPIO IP core</span>
00059 <span class="comment"> * M: a) added define Z17_MODEL_Z127</span>
00060 <span class="comment"> *    b) added Z17_MODEL_Z127 section to setstat/getstat functions</span>
00061 <span class="comment"> *</span>
00062 <span class="comment"> * Revision 1.5  2009/07/10 10:15:49  CRuff</span>
00063 <span class="comment"> * R: compiler warnings because of unused variables</span>
00064 <span class="comment"> * M: commented out the unused variables</span>
00065 <span class="comment"> *</span>
00066 <span class="comment"> * Revision 1.4  2009/04/17 10:23:38  MRoth</span>
00067 <span class="comment"> * R: no 64 Bit support</span>
00068 <span class="comment"> * M: changed set/getstat to support 64 Bit</span>
00069 <span class="comment"> *</span>
00070 <span class="comment"> * Revision 1.3  2006/12/20 11:23:21  ufranke</span>
00071 <span class="comment"> * added</span>
00072 <span class="comment"> *  + getstat code Z17_IRQ_LAST_REQUEST</span>
00073 <span class="comment"> *</span>
00074 <span class="comment"> * Revision 1.2  2006/06/01 17:03:12  cs</span>
00075 <span class="comment"> * changed ADDRSPACE_SIZE to 32 (real size is reported by Chameleon BBIS)</span>
00076 <span class="comment"> *</span>
00077 <span class="comment"> * Revision 1.1  2004/06/18 14:29:50  ub</span>
00078 <span class="comment"> * Initial Revision</span>
00079 <span class="comment"> *</span>
00080 <span class="comment"> *---------------------------------------------------------------------------</span>
00081 <span class="comment"> * (c) Copyright 2004 by MEN Mikro Elektronik GmbH, Nuernberg, Germany</span>
00082 <span class="comment"> ****************************************************************************/</span>
00083 
<a name="l00084"></a><a class="code" href="z17__drv_8c.html#a0">00084</a> <span class="preprocessor">#define _NO_LL_HANDLE        </span><span class="comment">/* ll_defs.h: don't define LL_HANDLE struct */</span>
00085 
00086 <span class="comment">/*-----------------------------------------+</span>
00087 <span class="comment">|  INCLUDES                                |</span>
00088 <span class="comment">+-----------------------------------------*/</span>
00089 <span class="preprocessor">#include &lt;MEN/men_typs.h&gt;</span>    <span class="comment">/* system dependent definitions   */</span>
00090 <span class="preprocessor">#include &lt;MEN/maccess.h&gt;</span>     <span class="comment">/* hw access macros and types     */</span>
00091 <span class="preprocessor">#include &lt;MEN/dbg.h&gt;</span>         <span class="comment">/* debug functions                */</span>
00092 <span class="preprocessor">#include &lt;MEN/oss.h&gt;</span>         <span class="comment">/* oss functions                  */</span>
00093 <span class="preprocessor">#include &lt;MEN/desc.h&gt;</span>        <span class="comment">/* descriptor functions           */</span>
00094 <span class="preprocessor">#include &lt;MEN/modcom.h&gt;</span>      <span class="comment">/* ID PROM functions              */</span>
00095 <span class="preprocessor">#include &lt;MEN/mdis_api.h&gt;</span>    <span class="comment">/* MDIS global defs               */</span>
00096 <span class="preprocessor">#include &lt;MEN/mdis_com.h&gt;</span>    <span class="comment">/* MDIS common defs               */</span>
00097 <span class="preprocessor">#include &lt;MEN/mdis_err.h&gt;</span>    <span class="comment">/* MDIS error codes               */</span>
00098 <span class="preprocessor">#include &lt;MEN/ll_defs.h&gt;</span>     <span class="comment">/* low-level driver definitions   */</span>
00099 <span class="preprocessor">#include &lt;MEN/arwen.h&gt;</span>       <span class="comment">/* definitions for Arwen GPIO     */</span>
00100 <span class="preprocessor">#include &lt;MEN/chameleon.h&gt;</span>   <span class="comment">/* chameleon header               */</span>
00101 
00102 <span class="comment">/*-----------------------------------------+</span>
00103 <span class="comment">|  DEFINES                                 |</span>
00104 <span class="comment">+-----------------------------------------*/</span>
00105 <span class="preprocessor">#if (defined(Z127V01) &amp;&amp; defined(MDIS_MA_BB_INFO_PTR))</span>
00106 <span class="preprocessor"></span><span class="preprocessor">    #define Z127_INFO_PTR 1</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00108 <span class="preprocessor"></span>
00109 <span class="comment">/* general defines */</span>
<a name="l00110"></a><a class="code" href="z17__drv_8c.html#a1">00110</a> <span class="preprocessor">#define CH_NUMBER          1          </span>
00111 <span class="preprocessor">#ifdef Z127_NOIRQ</span>
00112 <span class="preprocessor"></span><span class="preprocessor">  #define USE_IRQ            FALSE      </span>
00113 <span class="preprocessor">#else</span>
<a name="l00114"></a><a class="code" href="z17__drv_8c.html#a2">00114</a> <span class="preprocessor"></span><span class="preprocessor">  #define USE_IRQ            TRUE       </span>
00115 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00116 
00117 <span class="preprocessor">#ifdef Z127_INFO_PTR</span>
00118 <span class="preprocessor"></span><span class="preprocessor">    #define ADDRSPACE_COUNT    2          </span>
00119 <span class="preprocessor">    #define ADDRSPACE_SIZE     0x100      </span>
00120 <span class="preprocessor">#else</span>
<a name="l00121"></a><a class="code" href="z17__drv_8c.html#a3">00121</a> <span class="preprocessor"></span><span class="preprocessor">    #define ADDRSPACE_COUNT    1          </span>
<a name="l00122"></a><a class="code" href="z17__drv_8c.html#a4">00122</a> <span class="preprocessor">    #define ADDRSPACE_SIZE     0x20       </span>
00123 <span class="preprocessor">#endif</span>
00124 <span class="preprocessor"></span>
00125 <span class="comment">/* debug defines */</span>
<a name="l00126"></a><a class="code" href="z17__drv_8c.html#a5">00126</a> <span class="preprocessor">#define DBG_MYLEVEL        llHdl-&gt;dbgLevel    </span>
<a name="l00127"></a><a class="code" href="z17__drv_8c.html#a6">00127</a> <span class="preprocessor">#define DBH                llHdl-&gt;dbgHdl      </span>
<a name="l00128"></a><a class="code" href="z17__drv_8c.html#a7">00128</a> <span class="preprocessor">#define OSH                llHdl-&gt;osHdl       </span>
00130 <span class="preprocessor"></span><span class="comment">/* toggle mode defines */</span>
<a name="l00131"></a><a class="code" href="z17__drv_8c.html#a8">00131</a> <span class="preprocessor">#define TOG_TIME_DEFAULT   1000       </span>
<a name="l00132"></a><a class="code" href="z17__drv_8c.html#a9">00132</a> <span class="preprocessor">#define TOG_TIME_MIN       100        </span>
<a name="l00133"></a><a class="code" href="z17__drv_8c.html#a10">00133</a> <span class="preprocessor">#define TOG_TIME_MAX       60000      </span>
<a name="l00134"></a><a class="code" href="z17__drv_8c.html#a11">00134</a> <span class="preprocessor">#define TOG_CYCLIC         1          </span>
00136 <span class="preprocessor"></span><span class="comment">/* descriptor key defines*/</span>
<a name="l00137"></a><a class="code" href="z17__drv_8c.html#a12">00137</a> <span class="preprocessor">#define RESET_DEFAULT      0          </span>
<a name="l00138"></a><a class="code" href="z17__drv_8c.html#a13">00138</a> <span class="preprocessor">#define RESET_OFF          1          </span>
00140 <span class="preprocessor"></span><span class="comment">/*-----------------------------------------+</span>
00141 <span class="comment">|  TYPEDEFS                                |</span>
00142 <span class="comment">+-----------------------------------------*/</span>
00143 
<a name="l00144"></a><a class="code" href="structLL__HANDLE.html">00144</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00145     <span class="comment">/* general */</span>
<a name="l00146"></a><a class="code" href="structLL__HANDLE.html#o0">00146</a>     int32                   memAlloc;       
<a name="l00147"></a><a class="code" href="structLL__HANDLE.html#o1">00147</a>     OSS_HANDLE              *osHdl;         
<a name="l00148"></a><a class="code" href="structLL__HANDLE.html#o2">00148</a>     OSS_IRQ_HANDLE          *irqHdl;        
<a name="l00149"></a><a class="code" href="structLL__HANDLE.html#o3">00149</a>     DESC_HANDLE             *descHdl;       
<a name="l00150"></a><a class="code" href="structLL__HANDLE.html#o4">00150</a>     MACCESS                 ma;             
00151 <span class="preprocessor">#ifdef Z127_INFO_PTR</span>
00152 <span class="preprocessor"></span>    CHAMELEONV2_UNIT        *chamu;         
00153     u_int32                 vdt;            
00154 <span class="preprocessor">#endif</span>
<a name="l00155"></a><a class="code" href="structLL__HANDLE.html#o5">00155</a> <span class="preprocessor"></span>    MDIS_IDENT_FUNCT_TBL    idFuncTbl;      
00156     <span class="comment">/* debug */</span>
<a name="l00157"></a><a class="code" href="structLL__HANDLE.html#o6">00157</a>     u_int32                 dbgLevel;       
<a name="l00158"></a><a class="code" href="structLL__HANDLE.html#o7">00158</a>     DBG_HANDLE              *dbgHdl;        
00159 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00160 <span class="preprocessor"></span>    <span class="comment">/* misc */</span>
<a name="l00161"></a><a class="code" href="structLL__HANDLE.html#o8">00161</a>     OSS_SIG_HANDLE          *portChangeSig; 
<a name="l00162"></a><a class="code" href="structLL__HANDLE.html#o9">00162</a>     u_int32                 irqCount;       
<a name="l00163"></a><a class="code" href="structLL__HANDLE.html#o10">00163</a>     u_int32                 lastReq;        
00164     <span class="comment">/* IRQ latency test */</span>
<a name="l00165"></a><a class="code" href="structLL__HANDLE.html#o11">00165</a>     u_int32                 irqTest;        <span class="comment">/* test running flag (1=on) */</span>
<a name="l00166"></a><a class="code" href="structLL__HANDLE.html#o12">00166</a>     int32                   outBit;         <span class="comment">/* output bit 0..31       */</span>
<a name="l00167"></a><a class="code" href="structLL__HANDLE.html#o13">00167</a>     u_int32                 outLast;        <span class="comment">/* last set output value (1 or 0) */</span>
<a name="l00168"></a><a class="code" href="structLL__HANDLE.html#o14">00168</a>     u_int32                 irqs2fire;      <span class="comment">/* number of IRQs to fire */</span>
<a name="l00169"></a><a class="code" href="structLL__HANDLE.html#o15">00169</a>     u_int32                 startTick;      <span class="comment">/* start tick count       */</span>
<a name="l00170"></a><a class="code" href="structLL__HANDLE.html#o16">00170</a>     u_int32                 stopTick;       <span class="comment">/* stop tick count        */</span>
00171 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00172     <span class="comment">/* toggle mode */</span>
<a name="l00173"></a><a class="code" href="structLL__HANDLE.html#o17">00173</a>     OSS_ALARM_HANDLE        *alarmHdl;      
<a name="l00174"></a><a class="code" href="structLL__HANDLE.html#o18">00174</a>     OSS_SEM_HANDLE          *devSemHdl;     
<a name="l00175"></a><a class="code" href="structLL__HANDLE.html#o19">00175</a>     u_int32                 togHigh;        
<a name="l00176"></a><a class="code" href="structLL__HANDLE.html#o20">00176</a>     u_int32                 togtimeHigh;    
<a name="l00177"></a><a class="code" href="structLL__HANDLE.html#o21">00177</a>     u_int32                 togtimeLow;     
<a name="l00178"></a><a class="code" href="structLL__HANDLE.html#o22">00178</a>     u_int32                 togBitMask;     
<a name="l00179"></a><a class="code" href="structLL__HANDLE.html#o23">00179</a>     u_int32                 togCount;       
00180     <span class="comment">/* arwen no reset */</span>
<a name="l00181"></a><a class="code" href="structLL__HANDLE.html#o24">00181</a>     u_int32                 arwenResetOff;  
00182 } <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>;
00183 
00184 <span class="comment">/* include files which need LL_HANDLE */</span>
00185 <span class="preprocessor">#include &lt;MEN/ll_entry.h&gt;</span>       <span class="comment">/* low-level driver jump table */</span>
00186 <span class="preprocessor">#include &lt;<a class="code" href="z17__drv_8h.html">MEN/z17_drv.h</a>&gt;</span>        <span class="comment">/* Z17 driver header file      */</span>
00187 
00188 <span class="comment">/*-----------------------------------------+</span>
00189 <span class="comment">|  PROTOTYPES                              |</span>
00190 <span class="comment">+-----------------------------------------*/</span>
00191 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a14">Z17_Init</a>(DESC_SPEC *descSpec, OSS_HANDLE *osHdl,
00192                         MACCESS *ma, OSS_SEM_HANDLE *devSemHdl,
00193                         OSS_IRQ_HANDLE *irqHdl, <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP);
00194 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a15">Z17_Exit</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP);
00195 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a16">Z17_Read</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 *value);
00196 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a17">Z17_Write</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 value);
00197 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a18">Z17_SetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,int32 ch, int32 code,
00198                             INT32_OR_64 value32_or_64);
00199 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a19">Z17_GetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 code,
00200                             INT32_OR_64 *value32_or64P);
00201 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a20">Z17_BlockRead</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00202                             int32 *nbrRdBytesP);
00203 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a21">Z17_BlockWrite</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00204                                 int32 *nbrWrBytesP);
00205 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00206 <span class="preprocessor"></span>    <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a22">Z17_Irq</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl);
00207 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00208 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a23">Z17_Info</a>(int32 infoType, ...);
00209 <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z17__drv_8c.html#a24">Ident</a>(<span class="keywordtype">void</span>);
00210 <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 retCode);
00211 <span class="keyword">static</span> <span class="keywordtype">void</span>  <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl);
00212 
00213 <span class="keyword">static</span> <span class="keywordtype">void</span>  <a class="code" href="z17__drv_8c.html#a27">AlarmHandler</a>(<span class="keywordtype">void</span> *arg);
00214 
00215 <span class="comment">/****************************** Z17_GetEntry ********************************/</span>
00220 <span class="preprocessor">#ifdef _ONE_NAMESPACE_PER_DRIVER_</span>
00221 <span class="preprocessor"></span>    <span class="keyword">extern</span> <span class="keywordtype">void</span> LL_GetEntry(
00222         LL_ENTRY* drvP
00223     )
00224 #<span class="keywordflow">else</span>
<a name="l00225"></a><a class="code" href="z17__drv_8c.html#a28">00225</a>     <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="z17__drv_8h.html#a19">__Z17_GetEntry</a>(
00226         LL_ENTRY* drvP
00227     )
00228 #endif
00229 {
00230     drvP-&gt;init        = <a class="code" href="z17__drv_8c.html#a14">Z17_Init</a>;
00231     drvP-&gt;exit        = <a class="code" href="z17__drv_8c.html#a15">Z17_Exit</a>;
00232     drvP-&gt;read        = <a class="code" href="z17__drv_8c.html#a16">Z17_Read</a>;
00233     drvP-&gt;write       = <a class="code" href="z17__drv_8c.html#a17">Z17_Write</a>;
00234     drvP-&gt;blockRead   = <a class="code" href="z17__drv_8c.html#a20">Z17_BlockRead</a>;
00235     drvP-&gt;blockWrite  = <a class="code" href="z17__drv_8c.html#a21">Z17_BlockWrite</a>;
00236     drvP-&gt;setStat     = <a class="code" href="z17__drv_8c.html#a18">Z17_SetStat</a>;
00237     drvP-&gt;getStat     = <a class="code" href="z17__drv_8c.html#a19">Z17_GetStat</a>;
00238 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00239 <span class="preprocessor"></span>    drvP-&gt;irq         = <a class="code" href="z17__drv_8c.html#a22">Z17_Irq</a>;
00240 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00241     drvP-&gt;info        = <a class="code" href="z17__drv_8c.html#a23">Z17_Info</a>;
00242 }
00243 
00244 <span class="comment">/******************************** Z17_Init **********************************/</span>
<a name="l00269"></a><a class="code" href="z17__drv_8c.html#a14">00269</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a14">Z17_Init</a>(
00270     DESC_SPEC       *descP,
00271     OSS_HANDLE      *osHdl,
00272     MACCESS         *ma,
00273     OSS_SEM_HANDLE  *devSemHdl,
00274     OSS_IRQ_HANDLE  *irqHdl,
00275     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>       **llHdlP
00276 )
00277 {
00278     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = NULL;
00279     u_int32 gotsize;
00280     int32 error;
00281     u_int32 value;
00282 
00283     <span class="comment">/*------------------------------+</span>
00284 <span class="comment">    |  prepare the handle           |</span>
00285 <span class="comment">    +------------------------------*/</span>
00286     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00287 
00288     <span class="comment">/* alloc */</span>
00289     <span class="keywordflow">if</span> ((llHdl = (<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>*)OSS_MemGet(
00290                     osHdl, <span class="keyword">sizeof</span>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>), &amp;gotsize)) == NULL)
00291         <span class="keywordflow">return</span> (ERR_OSS_MEM_ALLOC);
00292 
00293     <span class="comment">/* clear */</span>
00294     OSS_MemFill(osHdl, gotsize, (<span class="keywordtype">char</span>*)llHdl, 0x00);
00295 
00296     <span class="comment">/* init */</span>
00297     llHdl-&gt;memAlloc    = gotsize;
00298     llHdl-&gt;osHdl       = osHdl;
00299 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00300 <span class="preprocessor"></span>    llHdl-&gt;irqHdl      = irqHdl;
00301 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00302     llHdl-&gt;ma          = *ma;
00303     llHdl-&gt;devSemHdl   = devSemHdl;
00304     llHdl-&gt;togtimeHigh = <a class="code" href="z17__drv_8c.html#a8">TOG_TIME_DEFAULT</a>;
00305     llHdl-&gt;togtimeLow  = <a class="code" href="z17__drv_8c.html#a8">TOG_TIME_DEFAULT</a>;
00306     llHdl-&gt;togBitMask  = 0;
00307     llHdl-&gt;togCount    = 0;
00308     llHdl-&gt;togHigh     = 0;
00309 
00310 <span class="preprocessor">#ifdef Z127_INFO_PTR</span>
00311 <span class="preprocessor"></span>    llHdl-&gt;chamu       = (CHAMELEONV2_UNIT*)ma[1];
00312 <span class="preprocessor">#endif </span>
00313 <span class="preprocessor"></span>
00314     <span class="comment">/*------------------------------+</span>
00315 <span class="comment">    |  init id function table       |</span>
00316 <span class="comment">    +------------------------------*/</span>
00317     <span class="comment">/* driver's ident function */</span>
00318     llHdl-&gt;idFuncTbl.idCall[0].identCall = <a class="code" href="z17__drv_8c.html#a24">Ident</a>;
00319     <span class="comment">/* library's ident functions */</span>
00320     llHdl-&gt;idFuncTbl.idCall[1].identCall = DESC_Ident;
00321     llHdl-&gt;idFuncTbl.idCall[2].identCall = OSS_Ident;
00322     <span class="comment">/* terminator */</span>
00323     llHdl-&gt;idFuncTbl.idCall[3].identCall = NULL;
00324 
00325     <span class="comment">/*------------------------------+</span>
00326 <span class="comment">    |  prepare debugging            |</span>
00327 <span class="comment">    +------------------------------*/</span>
00328     <a class="code" href="z17__drv_8c.html#a5">DBG_MYLEVEL</a> = OSS_DBG_DEFAULT;      <span class="comment">/* set OS specific debug level */</span>
00329     DBGINIT((NULL,&amp;<a class="code" href="z17__drv_8c.html#a6">DBH</a>));
00330 
00331     <span class="comment">/*------------------------------+</span>
00332 <span class="comment">    |  scan descriptor              |</span>
00333 <span class="comment">    +------------------------------*/</span>
00334     <span class="comment">/* prepare access */</span>
00335     <span class="keywordflow">if</span> ((error = DESC_Init(descP, osHdl, &amp;llHdl-&gt;descHdl)))
00336         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00337 
00338     <span class="comment">/* DEBUG_LEVEL_DESC */</span>
00339     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00340                                 &amp;value, <span class="stringliteral">"DEBUG_LEVEL_DESC"</span>)) &amp;&amp;
00341         error != ERR_DESC_KEY_NOTFOUND)
00342         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00343 
00344     DESC_DbgLevelSet(llHdl-&gt;descHdl, value);    <span class="comment">/* set level */</span>
00345 
00346     <span class="comment">/* DEBUG_LEVEL */</span>
00347     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00348                                 &amp;llHdl-&gt;dbgLevel, <span class="stringliteral">"DEBUG_LEVEL"</span>)) &amp;&amp;
00349         error != ERR_DESC_KEY_NOTFOUND)
00350         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00351 
00352     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Init: base address = %08p\n"</span>, (<span class="keywordtype">void</span>*)llHdl-&gt;ma));
00353 
00354 <span class="preprocessor">#ifdef Z127_INFO_PTR</span>
00355 <span class="preprocessor"></span>    <span class="comment">/* print chameleon info */</span>
00356     DBGWRT_1(( <a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"   device ID:\t0x%02x \n"</span>,llHdl-&gt;chamu-&gt;devId));
00357     DBGWRT_1(( <a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"   variant:  \t0x%02x \n"</span>,llHdl-&gt;chamu-&gt;variant));
00358     DBGWRT_1(( <a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"   revision: \t0x%02x \n\n"</span>,llHdl-&gt;chamu-&gt;revision));
00359     
00360     <span class="keywordflow">if</span>( llHdl-&gt;chamu-&gt;variant &gt; 0 )
00361         llHdl-&gt;vdt = 1;
00362 <span class="preprocessor">#endif</span>
00363 <span class="preprocessor"></span>
00364     <span class="comment">/* RESET_OFF */</span>
00365     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, <a class="code" href="z17__drv_8c.html#a12">RESET_DEFAULT</a>,
00366                                 &amp;llHdl-&gt;arwenResetOff, <span class="stringliteral">"RESET_OFF"</span>)) &amp;&amp;
00367         error != ERR_DESC_KEY_NOTFOUND)
00368         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00369 
00370     <span class="comment">/*------------------------------+</span>
00371 <span class="comment">    |  init alarm                   |</span>
00372 <span class="comment">    +------------------------------*/</span>
00373     <span class="keywordflow">if</span> ((error = OSS_AlarmCreate(llHdl-&gt;osHdl, <a class="code" href="z17__drv_8c.html#a27">AlarmHandler</a>, llHdl,
00374                                     &amp;llHdl-&gt;alarmHdl)))
00375         <span class="keywordflow">return</span> (<a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error));
00376 
00377     <span class="comment">/*------------------------------+</span>
00378 <span class="comment">    |  init hardware                |</span>
00379 <span class="comment">    +------------------------------*/</span>
00380     <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(llHdl);
00381     *llHdlP = llHdl;        <span class="comment">/* set low-level driver handle */</span>
00382 
00383     <span class="keywordflow">return</span> (ERR_SUCCESS);
00384 }
00385 
00386 <span class="comment">/****************************** Z17_Exit ************************************/</span>
<a name="l00396"></a><a class="code" href="z17__drv_8c.html#a15">00396</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a15">Z17_Exit</a>(
00397     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP
00398 )
00399 {
00400     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = *llHdlP;
00401     int32 error = 0;
00402 
00403     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Exit\n"</span>));
00404 
00405     <span class="comment">/*------------------------------+</span>
00406 <span class="comment">    |  de-init hardware             |</span>
00407 <span class="comment">    +------------------------------*/</span>
00408     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o24">arwenResetOff</a> == 0)
00409         <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(llHdl);
00410     <span class="comment">/*------------------------------+</span>
00411 <span class="comment">    |  clean up memory              |</span>
00412 <span class="comment">    +------------------------------*/</span>
00413     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00414     error = <a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(llHdl, error);
00415 
00416     <span class="keywordflow">return</span> (error);
00417 }
00418 
00419 <span class="comment">/****************************** Z17_Read ************************************/</span>
<a name="l00430"></a><a class="code" href="z17__drv_8c.html#a16">00430</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a16">Z17_Read</a>(
00431     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>  *llHdl,
00432     int32      ch,
00433     int32      *valueP
00434 )
00435 {
00436     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Read: ch=%d\n"</span>, ch));
00437 
00438     *valueP = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_02_PSR);
00439 
00440     <span class="keywordflow">return</span> (ERR_SUCCESS);
00441 }
00442 
00443 <span class="comment">/****************************** Z17_Write ***********************************/</span>
<a name="l00454"></a><a class="code" href="z17__drv_8c.html#a17">00454</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a17">Z17_Write</a>(
00455     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>  *llHdl,
00456     int32      ch,
00457     int32      value
00458 )
00459 {
00460     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_Write: ch=%d  val=0x%x\n"</span>, ch, value));
00461 
00462     MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_GPIO, value);
00463 
00464     <span class="keywordflow">return</span> (ERR_SUCCESS);
00465 }
00466 
00467 <span class="comment">/****************************** Z17_SetStat *********************************/</span>
<a name="l00481"></a><a class="code" href="z17__drv_8c.html#a18">00481</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a18">Z17_SetStat</a>(
00482     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>   *llHdl,
00483     int32       code,
00484     int32       ch,
00485     INT32_OR_64 value32_or_64
00486 )
00487 {
00488     int32 value = (int32)value32_or_64;     <span class="comment">/* 32bit value */</span>
00489 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00490 <span class="preprocessor"></span>    <a class="code" href="z17__drv_8h.html#a20">INT32_OR_64</a> valueP = value32_or_64;     <span class="comment">/* stores 32/64bit pointer */</span>
00491     M_SG_BLOCK *blk = (M_SG_BLOCK*)valueP;  <span class="comment">/* stores block struct pointer */</span>
00492 <span class="preprocessor">#endif</span>
00493 <span class="preprocessor"></span>    MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>;
00494     int32 error = ERR_SUCCESS;
00495 
00496     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_SetStat: ch=%d code=0x%04x value=0x%x\n"</span>,
00497                 ch, code, value));
00498 
00499     <span class="keywordflow">switch</span> (code) {
00500         <span class="comment">/*--------------------------+</span>
00501 <span class="comment">        |  debug level              |</span>
00502 <span class="comment">        +--------------------------*/</span>
00503         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00504             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o6">dbgLevel</a> = value;
00505             <span class="keywordflow">break</span>;
00506         <span class="comment">/*--------------------------+</span>
00507 <span class="comment">        |  enable interrupts        |</span>
00508 <span class="comment">        +--------------------------*/</span>
00509         <span class="keywordflow">case</span> M_MK_IRQ_ENABLE:
00510             <span class="keywordflow">break</span>;
00511         <span class="comment">/*--------------------------+</span>
00512 <span class="comment">        |  set irq counter          |</span>
00513 <span class="comment">        +--------------------------*/</span>
00514         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00515 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00516 <span class="preprocessor"></span>            llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a> = value;
00517 <span class="preprocessor">#endif</span>
00518 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00519         <span class="comment">/*--------------------------+</span>
00520 <span class="comment">        |  channel direction        |</span>
00521 <span class="comment">        +--------------------------*/</span>
00522         <span class="keywordflow">case</span> M_LL_CH_DIR:
00523             <span class="keywordflow">if</span> (value != M_CH_INOUT) {
00524                 error = ERR_LL_ILL_DIR;
00525             }
00526             <span class="keywordflow">break</span>;
00527         <span class="comment">/*--------------------------+</span>
00528 <span class="comment">        |  set IO ports             |</span>
00529 <span class="comment">        +--------------------------*/</span>
00530         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a0">Z17_SET_PORTS</a>:
00531             MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO) | value);
00532             <span class="comment">/* remove bit from toggle mode */</span>
00533             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a>) {
00534                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a> &amp;= ~value;
00535                 <span class="comment">/* stop alarm if last bit is set */</span>
00536                 <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a>)
00537                     error = OSS_AlarmClear(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">alarmHdl</a>);
00538             }
00539             <span class="keywordflow">break</span>;
00540         <span class="comment">/*--------------------------+</span>
00541 <span class="comment">        |  clear IO ports           |</span>
00542 <span class="comment">        +--------------------------*/</span>
00543         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a1">Z17_CLR_PORTS</a>:
00544             MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO) &amp; ~value);
00545             <span class="comment">/* remove bit from toggle mode */</span>
00546             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a>) {
00547                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a> &amp;= ~value;
00548                 <span class="comment">/* stop alarm if last bit is cleared */</span>
00549                 <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a>)
00550                     error = OSS_AlarmClear(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">alarmHdl</a>);
00551             }
00552             <span class="keywordflow">break</span>;
00553         <span class="comment">/*--------------------------+</span>
00554 <span class="comment">        |  port direction           |</span>
00555 <span class="comment">        +--------------------------*/</span>
00556         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a2">Z17_DIRECTION</a>:
00557             MWRITE_D32(ma, ARWEN_DDR, value);
00558             <span class="keywordflow">break</span>;
00559 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00560 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00561 <span class="comment">        |  edge for interrupt       |</span>
00562 <span class="comment">        +--------------------------*/</span>
00563         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a3">Z17_IRQ_SENSE</a>:
00564 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00565 <span class="preprocessor"></span>        <span class="comment">/* Z34/Z37 - 8 GPIOs */</span>
00566             MWRITE_D32(ma, ARWEN_02_IER1, value &amp; 0xff);
00567             MWRITE_D32(ma, ARWEN_02_IER2, (value &gt;&gt; 8) &amp; 0xff);
00568             <span class="keywordflow">break</span>;
00569 <span class="preprocessor">#else</span>
00570 <span class="preprocessor"></span>        <span class="comment">/* Z127: GPIOs 0..15 - two bits per GPIO */</span>
00571             MWRITE_D32(ma, ARWEN_02_IER1, value);
00572             <span class="keywordflow">break</span>;
00573         <span class="comment">/* Z127: GPIOs 16..31 - two bits per GPIO */</span>
00574         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a9">Z17_IRQ_SENSE_16TO31</a>:
00575             MWRITE_D32(ma, ARWEN_02_IER2, value);
00576             <span class="keywordflow">break</span>;
00577 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00578 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00579         <span class="comment">/*--------------------------+</span>
00580 <span class="comment">        |  open drain               |</span>
00581 <span class="comment">        +--------------------------*/</span>
00582         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a4">Z17_OPEN_DRAIN</a>:
00583             MWRITE_D32(ma, ARWEN_02_ODER, value);
00584             <span class="keywordflow">break</span>;
00585         <span class="comment">/*--------------------------+</span>
00586 <span class="comment">        |  debouncer                |</span>
00587 <span class="comment">        +--------------------------*/</span>
00588         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a5">Z17_DEBOUNCE</a>:
00589             MWRITE_D32(ma, ARWEN_02_DBER, value);
00590             <span class="keywordflow">break</span>;
00591             
00592 <span class="preprocessor">#ifdef Z127_INFO_PTR            </span>
00593 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a15">Z17_BLK_DEBOUNCE_TIME</a>:
00594         {
00595             int8 port;
00596             <a class="code" href="structZ17__BLK__DEBTIME.html">Z17_BLK_DEBTIME</a> *dbt = (<a class="code" href="structZ17__BLK__DEBTIME.html">Z17_BLK_DEBTIME</a>*)blk-&gt;data;         
00597         
00598             <span class="comment">/* prevent access to not implemented DBCR registers */</span>      
00599             <span class="keywordflow">if</span>( llHdl-&gt;vdt == 0 ){
00600                 DBGWRT_ERR((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** LL - Z17_SetStat(Z17_BLK_DEBOUNCE_TIME): "</span>
00601                     <span class="stringliteral">" requires at least 16Z127 variant 1 IP core\n"</span>));
00602                 <span class="keywordflow">return</span> ERR_LL_ILL_FUNC;
00603             }
00604                     
00605             <span class="keywordflow">for</span>( port=0; port&lt;32; port++ ){
00606                 <span class="keywordflow">if</span>( (dbt-&gt;<a class="code" href="structZ17__BLK__DEBTIME.html#o0">portMask</a> &amp; (1&lt;&lt;port)) ){
00607                     MWRITE_D32(ma, ARWEN_Z127V01_DBCR(port), dbt-&gt;<a class="code" href="structZ17__BLK__DEBTIME.html#o1">timeUs</a>/50);
00608                 }
00609             }       
00610 
00611             <span class="keywordflow">break</span>;
00612         }
00613 <span class="preprocessor">#endif</span>
00614 <span class="preprocessor"></span>                    
00615 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00616 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00617 <span class="comment">        |  register signal          |</span>
00618 <span class="comment">        +--------------------------*/</span>
00619         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a6">Z17_SET_SIGNAL</a>:
00620             <span class="comment">/* signal already installed ? */</span>
00621             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">portChangeSig</a>) {
00622                 error = ERR_OSS_SIG_SET;
00623                 <span class="keywordflow">break</span>;
00624             }
00625             error = OSS_SigCreate(<a class="code" href="z17__drv_8c.html#a7">OSH</a>, value, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">portChangeSig</a>);
00626             <span class="keywordflow">break</span>;
00627         <span class="comment">/*--------------------------+</span>
00628 <span class="comment">        |  unregister signal        |</span>
00629 <span class="comment">        +--------------------------*/</span>
00630         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a7">Z17_CLR_SIGNAL</a>:
00631             <span class="comment">/* signal already installed ? */</span>
00632             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">portChangeSig</a> == NULL) {
00633                 error = ERR_OSS_SIG_CLR;
00634                 <span class="keywordflow">break</span>;
00635             }
00636             error = OSS_SigRemove(<a class="code" href="z17__drv_8c.html#a7">OSH</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">portChangeSig</a>);
00637             <span class="keywordflow">break</span>;
00638         <span class="comment">/*--------------------------+</span>
00639 <span class="comment">        |  init IRQ latency test    |</span>
00640 <span class="comment">        +--------------------------*/</span>
00641         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a13">Z17_BLK_IRQLAT_START</a>:
00642         {
00643             int32 value;
00644             <a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a> *irqlat = (<a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a>*)blk-&gt;data;
00645 
00646             <span class="comment">/* clear out values */</span>
00647             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o4">startTick</a> = 0;
00648             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o5">stopTick</a> = 0;
00649             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o6">irqsRcved</a> = 0;
00650 
00651             <span class="comment">/* init */</span>
00652             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">irqTest</a> = 1;
00653             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">irqs2fire</a> = irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o2">irqs2fire</a>-1;
00654             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a> = 0;
00655             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o16">stopTick</a> = 0;
00656 
00657             <span class="comment">/* compute and save output bit */</span>
00658             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o12">outBit</a> = 1 &lt;&lt; irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o0">outPort</a>;
00659 
00660             <span class="comment">/* disable all interrupts */</span>
00661             MWRITE_D32(ma, ARWEN_02_IER1, 0);
00662             MWRITE_D32(ma, ARWEN_02_IER2, 0);
00663 
00664             <span class="comment">/* program all ports as inputs */</span>
00665             MWRITE_D32(ma, ARWEN_DDR, 0);
00666 
00667             <span class="comment">/* determine actual state of output port */</span>
00668             value = MREAD_D32(ma, ARWEN_02_PSR);
00669             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">outLast</a> = (value &amp; llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o12">outBit</a>) ? 1 : 0;
00670 
00671             <span class="comment">/* preset output port value */</span>
00672             MWRITE_D32(ma, ARWEN_GPIO, value);
00673 
00674             <span class="comment">/* enable IRQ for rising+falling edge of input port */</span>
00675 <span class="comment">/* Z34/Z37 - 8 GPIOs */</span>
00676 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00677 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o1">inPort</a> &lt; 4) <span class="comment">/* port 3..0 */</span>
00678                 MWRITE_D32(ma, ARWEN_02_IER1, 3 &lt;&lt; (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o1">inPort</a> * 2));
00679             <span class="keywordflow">else</span>    <span class="comment">/* port 8..4 */</span>
00680                 MWRITE_D32(ma, ARWEN_02_IER2, 3 &lt;&lt; ((irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o1">inPort</a>-4) * 2));
00681 <span class="comment">/* Z127 - 32 GPIOs */</span>
00682 <span class="preprocessor">#else</span>
00683 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o1">inPort</a> &lt; 16)    <span class="comment">/* port 15..0 */</span>
00684                 MWRITE_D32(ma, ARWEN_02_IER1, 3 &lt;&lt; (irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o1">inPort</a> * 2));
00685             <span class="keywordflow">else</span>    <span class="comment">/* port 32..16 */</span>
00686                 MWRITE_D32(ma, ARWEN_02_IER2, 3 &lt;&lt; ((irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o1">inPort</a>-16) * 2));
00687 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00688             <span class="comment">/* config port as output (default is input) */</span>
00689             MWRITE_D32(ma, ARWEN_DDR, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o12">outBit</a>);
00690 
00691             <span class="comment">/* set output (this fires the first IRQ) */</span>
00692             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">outLast</a> = !llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">outLast</a>;
00693             DBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"set output=0x%x, irqs2fire=%d\n"</span>,
00694                         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">outLast</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">irqs2fire</a>));
00695             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">startTick</a> = OSS_TickGet(<a class="code" href="z17__drv_8c.html#a7">OSH</a>);
00696             MWRITE_D32(ma, ARWEN_GPIO, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">outLast</a> ? llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o12">outBit</a> : 0);
00697             <span class="keywordflow">break</span>;
00698         }
00699 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00700         <span class="comment">/*--------------------------+</span>
00701 <span class="comment">        |  Toggle mode              |</span>
00702 <span class="comment">        +--------------------------*/</span>
00703         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a10">Z17_TOG_PORTS</a>:
00704         {
00705             u_int32 realMsec;
00706 
00707             <span class="comment">/* start timer initially */</span>
00708             <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a>) {
00709                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a> = value;
00710                 error = OSS_AlarmSet(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">alarmHdl</a>,
00711                                         <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>, <a class="code" href="z17__drv_8c.html#a11">TOG_CYCLIC</a>, &amp;realMsec);
00712             } <span class="keywordflow">else</span> {
00713                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a> |= value;
00714                 <span class="comment">/* reset timer */</span>
00715                 error = OSS_AlarmClear(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">alarmHdl</a>);
00716                 error = OSS_AlarmSet(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">alarmHdl</a>,
00717                                         <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>, <a class="code" href="z17__drv_8c.html#a11">TOG_CYCLIC</a>, &amp;realMsec);
00718             }
00719             <span class="keywordflow">break</span>;
00720         }
00721         <span class="comment">/*--------------------------+</span>
00722 <span class="comment">        |  Toggle mode - high       |</span>
00723 <span class="comment">        +--------------------------*/</span>
00724         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a11">Z17_TOG_HIGH</a>:
00725             <span class="comment">/* adjust time value (100ms resolution) */</span>
00726             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o20">togtimeHigh</a> = (value / <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>) * <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00727             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o20">togtimeHigh</a> &gt; <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>)
00728                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o20">togtimeHigh</a> = <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>;
00729             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o20">togtimeHigh</a> &lt; <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>)
00730                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o20">togtimeHigh</a> = <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00731             <span class="keywordflow">break</span>;
00732         <span class="comment">/*--------------------------+</span>
00733 <span class="comment">        |  Toggle mode - low        |</span>
00734 <span class="comment">        +--------------------------*/</span>
00735         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a12">Z17_TOG_LOW</a>:
00736             <span class="comment">/* adjust time value (100ms resolution) */</span>
00737             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o21">togtimeLow</a> = (value / <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>) * <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00738             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o21">togtimeLow</a> &gt; <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>)
00739                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o21">togtimeLow</a> = <a class="code" href="z17__drv_8c.html#a10">TOG_TIME_MAX</a>;
00740             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o21">togtimeLow</a> &lt; <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>)
00741                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o21">togtimeLow</a> = <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
00742             <span class="keywordflow">break</span>;
00743         <span class="comment">/*--------------------------+</span>
00744 <span class="comment">        |  (unknown)                |</span>
00745 <span class="comment">        +--------------------------*/</span>
00746         <span class="keywordflow">default</span>:
00747             error = ERR_LL_UNK_CODE;
00748     }
00749 
00750     <span class="keywordflow">return</span> (error);
00751 }
00752 
00753 <span class="comment">/****************************** Z17_GetStat *********************************/</span>
<a name="l00770"></a><a class="code" href="z17__drv_8c.html#a19">00770</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a19">Z17_GetStat</a>(
00771     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>   *llHdl,
00772     int32       code,
00773     int32       ch,
00774     INT32_OR_64 *value32_or_64P
00775 )
00776 {
00777     int32 *valueP = (int32*)value32_or_64P;     <span class="comment">/* pointer to 32bit value */</span>
00778     <a class="code" href="z17__drv_8h.html#a20">INT32_OR_64</a> *value64P = value32_or_64P;     <span class="comment">/* stores 32/64bit pointer */</span>
00779     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>;
00780     int32 error = ERR_SUCCESS;
00781 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00782 <span class="preprocessor"></span>    M_SG_BLOCK *blk = (M_SG_BLOCK*)value32_or_64P;  <span class="comment">/* stores block struct pointer; not needed here */</span>
00783     OSS_IRQ_STATE irqState;
00784 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00785 
00786     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_GetStat: ch=%d code=0x%04x\n"</span>, ch, code));
00787 
00788     <span class="keywordflow">switch</span> (code) {
00789         <span class="comment">/*--------------------------+</span>
00790 <span class="comment">        |  debug level              |</span>
00791 <span class="comment">        +--------------------------*/</span>
00792         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00793             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o6">dbgLevel</a>;
00794             <span class="keywordflow">break</span>;
00795         <span class="comment">/*--------------------------+</span>
00796 <span class="comment">        |  number of channels       |</span>
00797 <span class="comment">        +--------------------------*/</span>
00798         <span class="keywordflow">case</span> M_LL_CH_NUMBER:
00799             *valueP = <a class="code" href="z17__drv_8c.html#a1">CH_NUMBER</a>;
00800             <span class="keywordflow">break</span>;
00801         <span class="comment">/*--------------------------+</span>
00802 <span class="comment">        |  channel direction        |</span>
00803 <span class="comment">        +--------------------------*/</span>
00804         <span class="keywordflow">case</span> M_LL_CH_DIR:
00805             *valueP = M_CH_INOUT;
00806             <span class="keywordflow">break</span>;
00807         <span class="comment">/*--------------------------+</span>
00808 <span class="comment">        |  channel length [bits]    |</span>
00809 <span class="comment">        +--------------------------*/</span>
00810         <span class="keywordflow">case</span> M_LL_CH_LEN:
00811 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00812 <span class="preprocessor"></span>            <span class="comment">/* Z34 / Z37 */</span>
00813             *valueP = 8;
00814             <span class="keywordflow">break</span>;
00815 <span class="preprocessor">#else</span>
00816 <span class="preprocessor"></span>            <span class="comment">/* Z127 */</span>
00817             *valueP = 32;
00818             <span class="keywordflow">break</span>;
00819 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00820         <span class="comment">/*--------------------------+</span>
00821 <span class="comment">        |  channel type info        |</span>
00822 <span class="comment">        +--------------------------*/</span>
00823         <span class="keywordflow">case</span> M_LL_CH_TYP:
00824             *valueP = M_CH_BINARY;
00825             <span class="keywordflow">break</span>;
00826         <span class="comment">/*--------------------------+</span>
00827 <span class="comment">        |  irq counter              |</span>
00828 <span class="comment">        +--------------------------*/</span>
00829         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00830 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00831 <span class="preprocessor"></span>            *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a>;
00832 <span class="preprocessor">#endif</span>
00833 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00834         <span class="comment">/*--------------------------+</span>
00835 <span class="comment">        |  ID PROM check enabled    |</span>
00836 <span class="comment">        +--------------------------*/</span>
00837         <span class="keywordflow">case</span> M_LL_ID_CHECK:
00838             *valueP = 0;
00839             <span class="keywordflow">break</span>;
00840         <span class="comment">/*--------------------------+</span>
00841 <span class="comment">        |  ident table pointer      |</span>
00842 <span class="comment">        |  (treat as non-block!)    |</span>
00843 <span class="comment">        +--------------------------*/</span>
00844         <span class="keywordflow">case</span> M_MK_BLK_REV_ID:
00845             *value64P = (<a class="code" href="z17__drv_8h.html#a20">INT32_OR_64</a>)&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o5">idFuncTbl</a>;
00846             <span class="keywordflow">break</span>;
00847         <span class="comment">/*--------------------------+</span>
00848 <span class="comment">        |  port direction           |</span>
00849 <span class="comment">        +--------------------------*/</span>
00850         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a2">Z17_DIRECTION</a>:
00851             *valueP = MREAD_D32(ma, ARWEN_DDR);
00852             <span class="keywordflow">break</span>;
00853 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00854 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00855 <span class="comment">        |  edge for interrupt       |</span>
00856 <span class="comment">        +--------------------------*/</span>
00857         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a3">Z17_IRQ_SENSE</a>:
00858 <span class="preprocessor">#ifndef Z17_MODEL_Z127</span>
00859 <span class="preprocessor"></span>            <span class="comment">/* Z34/Z37 */</span>
00860             *valueP = MREAD_D32(ma, ARWEN_02_IER1) |
00861                         MREAD_D32(ma, ARWEN_02_IER2) &lt;&lt; 8;
00862             <span class="keywordflow">break</span>;
00863 <span class="preprocessor">#else</span>
00864 <span class="preprocessor"></span>            <span class="comment">/* Z127: GPIOs 0..15 - two bits per GPIO */</span>
00865             *valueP = MREAD_D32(ma, ARWEN_02_IER1);
00866             <span class="keywordflow">break</span>;
00867         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a9">Z17_IRQ_SENSE_16TO31</a>:
00868             <span class="comment">/* Z127: GPIOs 16..31 - two bits per GPIO */</span>
00869             *valueP = MREAD_D32(ma, ARWEN_02_IER2);
00870             <span class="keywordflow">break</span>;
00871 <span class="preprocessor">#endif  </span><span class="comment">/* Z17_MODEL_Z127 */</span>
00872 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00873         <span class="comment">/*--------------------------+</span>
00874 <span class="comment">        |  open drain               |</span>
00875 <span class="comment">        +--------------------------*/</span>
00876         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a4">Z17_OPEN_DRAIN</a>:
00877             *valueP = MREAD_D32(ma, ARWEN_02_ODER);
00878             <span class="keywordflow">break</span>;
00879         <span class="comment">/*--------------------------+</span>
00880 <span class="comment">        |  debouncer                |</span>
00881 <span class="comment">        +--------------------------*/</span>
00882         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a5">Z17_DEBOUNCE</a>:
00883             *valueP = MREAD_D32(ma, ARWEN_02_DBER);
00884             <span class="keywordflow">break</span>;
00885 
00886 <span class="preprocessor">#ifdef Z127_INFO_PTR            </span>
00887 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a15">Z17_BLK_DEBOUNCE_TIME</a>:
00888         {
00889             int8    port, first=0;
00890             u_int32 timeUs=0;
00891             <a class="code" href="structZ17__BLK__DEBTIME.html">Z17_BLK_DEBTIME</a> *dbt = (<a class="code" href="structZ17__BLK__DEBTIME.html">Z17_BLK_DEBTIME</a>*)blk-&gt;data;         
00892             
00893             <span class="comment">/* prevent access to not implemented DBCR registers */</span>      
00894             <span class="keywordflow">if</span>( llHdl-&gt;vdt == 0 ){
00895                 DBGWRT_ERR((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** LL - Z17_GetStat(Z17_BLK_DEBOUNCE_TIME): "</span>
00896                     <span class="stringliteral">" requires at least 16Z127 variant 1 IP core\n"</span>));
00897                 <span class="keywordflow">return</span> ERR_LL_ILL_FUNC;
00898             }
00899 
00900             <span class="keywordflow">if</span>( dbt-&gt;<a class="code" href="structZ17__BLK__DEBTIME.html#o0">portMask</a> == 0 ){
00901                 DBGWRT_ERR((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** LL - Z17_GetStat(Z17_BLK_DEBOUNCE_TIME): "</span>
00902                     <span class="stringliteral">"no port specified\n"</span>));
00903                 <span class="keywordflow">return</span> ERR_LL_ILL_PARAM;
00904             }
00905         
00906             <span class="keywordflow">for</span>( port=0; port&lt;32; port++ ){
00907                 <span class="keywordflow">if</span>( (dbt-&gt;<a class="code" href="structZ17__BLK__DEBTIME.html#o0">portMask</a> &amp; (1&lt;&lt;port)) ){
00908                     <span class="keywordflow">if</span>( first&gt;0 ){
00909                         DBGWRT_ERR((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** LL - Z17_GetStat(Z17_BLK_DEBOUNCE_TIME): "</span>
00910                             <span class="stringliteral">"more than one port specified\n"</span>));
00911                         <span class="keywordflow">return</span> ERR_LL_ILL_PARAM;
00912                     }
00913                     timeUs = 50 * MREAD_D32(ma, ARWEN_Z127V01_DBCR(port));
00914                     first++;
00915                 }
00916             }
00917             
00918             dbt-&gt;<a class="code" href="structZ17__BLK__DEBTIME.html#o1">timeUs</a> = timeUs;       
00919             <span class="keywordflow">break</span>;
00920         }
00921 <span class="preprocessor">#endif                  </span>
00922 <span class="preprocessor"></span>            
00923 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
00924 <span class="preprocessor"></span>        <span class="comment">/*--------------------------+</span>
00925 <span class="comment">        |  last IRQ request         |</span>
00926 <span class="comment">        +--------------------------*/</span>
00927         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a8">Z17_IRQ_LAST_REQUEST</a>:
00928             irqState = OSS_IrqMaskR(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o2">irqHdl</a>);
00929             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">lastReq</a>;
00930             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">lastReq</a> = 0;
00931             OSS_IrqRestore(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o2">irqHdl</a>, irqState);
00932             <span class="keywordflow">break</span>;
00933         <span class="comment">/*--------------------------+</span>
00934 <span class="comment">        |  IRQ latency test result  |</span>
00935 <span class="comment">        +--------------------------*/</span>
00936         <span class="keywordflow">case</span> <a class="code" href="z17__drv_8h.html#a14">Z17_BLK_IRQLAT_RESULT</a>:
00937         {
00938             <a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a> *irqlat = (<a class="code" href="structZ17__BLK__IRQLAT.html">Z17_BLK_IRQLAT</a>*)blk-&gt;data;
00939 
00940             <span class="comment">/* IRQ latency test not started? */</span>
00941             <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">irqTest</a>) {
00942                 error = ERR_LL_DEV_NOTRDY;
00943                 <span class="keywordflow">break</span>;
00944             }
00945             <span class="comment">/* IRQ latency test not yet finished? */</span>
00946             <span class="keywordflow">if</span> (!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o16">stopTick</a>) {
00947                 error = ERR_LL_DEV_BUSY;
00948                 <span class="keywordflow">break</span>;
00949             }
00950             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">irqTest</a> = 0;
00951 
00952             <span class="comment">/* disable all IRQs */</span>
00953             MWRITE_D32(ma, ARWEN_02_IER1, 0);
00954             MWRITE_D32(ma, ARWEN_02_IER2, 0);
00955 
00956             <span class="comment">/* reset all outputs */</span>
00957             MWRITE_D32(ma, ARWEN_GPIO, 0);
00958 
00959             <span class="comment">/* program all ports as inputs */</span>
00960             MWRITE_D32(ma, ARWEN_DDR, 0);
00961 
00962             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o3">tickRate</a> = OSS_TickRateGet(<a class="code" href="z17__drv_8c.html#a7">OSH</a>);
00963             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o4">startTick</a> = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">startTick</a>;
00964             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o5">stopTick</a> = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o16">stopTick</a>;
00965             irqlat-&gt;<a class="code" href="structZ17__BLK__IRQLAT.html#o6">irqsRcved</a> = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a>;
00966             <span class="keywordflow">break</span>;
00967         }
00968 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
00969         <span class="comment">/*--------------------------+</span>
00970 <span class="comment">        |  (unknown)                |</span>
00971 <span class="comment">        +--------------------------*/</span>
00972         <span class="keywordflow">default</span>:
00973             error = ERR_LL_UNK_CODE;
00974     }
00975 
00976     <span class="keywordflow">return</span> (error);
00977 }
00978 
00979 <span class="comment">/******************************* Z17_BlockRead ******************************/</span>
<a name="l00990"></a><a class="code" href="z17__drv_8c.html#a20">00990</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a20">Z17_BlockRead</a>(
00991     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00992     int32     ch,
00993     <span class="keywordtype">void</span>      *buf,
00994     int32     size,
00995     int32     *nbrRdBytesP
00996 )
00997 {
00998     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_BlockRead: ch=%d, size=%d\n"</span>, ch, size));
00999 
01000     <span class="comment">/* return number of read bytes */</span>
01001     *nbrRdBytesP = 0;
01002 
01003     <span class="keywordflow">return</span> (ERR_LL_ILL_FUNC);
01004 }
01005 
01006 <span class="comment">/****************************** Z17_BlockWrite *****************************/</span>
<a name="l01017"></a><a class="code" href="z17__drv_8c.html#a21">01017</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a21">Z17_BlockWrite</a>(
01018     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
01019     int32     ch,
01020     <span class="keywordtype">void</span>      *buf,
01021     int32     size,
01022     int32     *nbrWrBytesP
01023 )
01024 {
01025     DBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z17_BlockWrite: ch=%d, size=%d\n"</span>, ch, size));
01026 
01027     <span class="comment">/* return number of written bytes */</span>
01028     *nbrWrBytesP = 0;
01029 
01030     <span class="keywordflow">return</span> (ERR_LL_ILL_FUNC);
01031 }
01032 
01033 <span class="preprocessor">#ifndef Z127_NOIRQ</span>
01034 <span class="preprocessor"></span><span class="comment">/****************************** Z17_Irq ************************************/</span>
<a name="l01053"></a><a class="code" href="z17__drv_8c.html#a22">01053</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a22">Z17_Irq</a>(
01054     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl
01055 )
01056 {
01057     u_int32 irqReq;
01058     u_int32 ier1, ier2;
01059 
01060     <span class="comment">/* interrupt caused by Arwen ? */</span>
01061     irqReq = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_IRR);
01062 
01063     IDBGWRT_1((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; LL - Z17_Irq: request %08x\n"</span>, irqReq));
01064     
01065     <span class="keywordflow">if</span> (irqReq) {
01066 
01067         <span class="comment">/* save IERs */</span>
01068         ier1 = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_02_IER1);
01069         ier2 = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_02_IER2);
01070         <span class="comment">/* disable all IRQs (for MSI(x)) */</span>
01071         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_02_IER1, 0);
01072         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_02_IER2, 0);
01073 
01074         <span class="comment">/* clear interrupt */</span>
01075         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_IRR, irqReq);
01076         
01077         <span class="comment">/* if requested send signal to application */</span>
01078         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">portChangeSig</a>)
01079             OSS_SigSend(<a class="code" href="z17__drv_8c.html#a7">OSH</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">portChangeSig</a>);
01080         
01081         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a>++;
01082         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">lastReq</a> = irqReq;
01083         
01084         <span class="comment">/* IRQ latency test */</span>
01085         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">irqTest</a>) {
01086             <span class="comment">/* pending IRQs to fire? */</span>
01087             IDBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; Z17_Irq: irqs2fire=%d\n"</span>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">irqs2fire</a>));
01088             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">irqs2fire</a>) {
01089                 <span class="comment">/* set output (this fires the next IRQ) */</span>
01090                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">outLast</a> = !llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">outLast</a>;
01091                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">irqs2fire</a>--;
01092                 IDBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; Z17_Irq: set output 0x%x\n"</span>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">outLast</a>));
01093                 MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_GPIO, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">outLast</a> ? llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o12">outBit</a> : 0);
01094             } <span class="keywordflow">else</span> {
01095                 <span class="comment">/* this was the last IRQ */</span>
01096                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o16">stopTick</a> = OSS_TickGet(<a class="code" href="z17__drv_8c.html#a7">OSH</a>);
01097             }
01098         }<span class="comment">/* IRQ latency test */</span>
01099         
01100         <span class="comment">/* enable all IRQs (for MSI(x)) */</span>
01101         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_02_IER1, ier1);
01102         MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, ARWEN_02_IER2, ier2);
01103 
01104         <span class="keywordflow">return</span> (LL_IRQ_DEVICE);
01105     }
01106 
01107     <span class="keywordflow">return</span> (LL_IRQ_DEV_NOT);
01108 }
01109 <span class="preprocessor">#endif  </span><span class="comment">/* Z127_NOIRQ */</span>
01110 
01111 <span class="comment">/****************************** Z17_Info ***********************************/</span>
<a name="l01149"></a><a class="code" href="z17__drv_8c.html#a23">01149</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a23">Z17_Info</a>(
01150     int32 infoType,
01151     ...
01152 )
01153 {
01154     int32   error = ERR_SUCCESS;
01155     va_list argptr;
01156 
01157     va_start(argptr, infoType);
01158 
01159     <span class="keywordflow">switch</span> (infoType) {
01160         <span class="comment">/*-------------------------------+</span>
01161 <span class="comment">        |  hardware characteristics      |</span>
01162 <span class="comment">        |  (all addr/data modes ORed)    |</span>
01163 <span class="comment">        +-------------------------------*/</span>
01164         <span class="keywordflow">case</span> LL_INFO_HW_CHARACTER:
01165         {
01166             u_int32 *addrModeP = va_arg(argptr, u_int32*);
01167             u_int32 *dataModeP = va_arg(argptr, u_int32*);
01168         
01169             *addrModeP = MDIS_MA08;
01170             *dataModeP = MDIS_MD08 | MDIS_MD16;
01171             <span class="keywordflow">break</span>;
01172         }
01173         <span class="comment">/*-------------------------------+</span>
01174 <span class="comment">        |  nr of required address spaces |</span>
01175 <span class="comment">        |  (total spaces used)           |</span>
01176 <span class="comment">        +-------------------------------*/</span>
01177         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE_COUNT:
01178         {
01179             u_int32 *nbrOfAddrSpaceP = va_arg(argptr, u_int32*);
01180         
01181             *nbrOfAddrSpaceP = <a class="code" href="z17__drv_8c.html#a3">ADDRSPACE_COUNT</a>;
01182             <span class="keywordflow">break</span>;
01183         }
01184         <span class="comment">/*-------------------------------+</span>
01185 <span class="comment">        |  address space type            |</span>
01186 <span class="comment">        |  (widest used data mode)       |</span>
01187 <span class="comment">        +-------------------------------*/</span>
01188         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE:
01189         {
01190             u_int32 addrSpaceIndex = va_arg(argptr, u_int32);
01191             u_int32 *addrModeP = va_arg(argptr, u_int32*);
01192             u_int32 *dataModeP = va_arg(argptr, u_int32*);
01193             u_int32 *addrSizeP = va_arg(argptr, u_int32*);
01194         
01195             <span class="keywordflow">switch</span>( addrSpaceIndex ){
01196                 <span class="keywordflow">case</span> 0:
01197                     *addrModeP = MDIS_MA08;
01198                     *dataModeP = MDIS_MD16;
01199                     *addrSizeP = <a class="code" href="z17__drv_8c.html#a4">ADDRSPACE_SIZE</a>;
01200                     <span class="keywordflow">break</span>;
01201 <span class="preprocessor">#ifdef Z127_INFO_PTR</span>
01202 <span class="preprocessor"></span>                <span class="keywordflow">case</span> 1:
01203                     *addrModeP = MDIS_MA_BB_INFO_PTR;
01204                     *dataModeP = MDIS_MD_CHAM_0;
01205                     *addrSizeP = <span class="keyword">sizeof</span>(CHAMELEONV2_UNIT);
01206                     <span class="keywordflow">break</span>;
01207 <span class="preprocessor">#endif</span>
01208 <span class="preprocessor"></span>
01209                 <span class="keywordflow">default</span>:
01210                     error = ERR_LL_ILL_PARAM;
01211             }
01212             <span class="keywordflow">break</span>;
01213         }
01214         <span class="comment">/*-------------------------------+</span>
01215 <span class="comment">        |  interrupt required            |</span>
01216 <span class="comment">        +-------------------------------*/</span>
01217         <span class="keywordflow">case</span> LL_INFO_IRQ:
01218         {
01219             u_int32 *useIrqP = va_arg(argptr, u_int32*);
01220 
01221             *useIrqP = <a class="code" href="z17__drv_8c.html#a2">USE_IRQ</a>;
01222             <span class="keywordflow">break</span>;
01223         }
01224         <span class="comment">/*-------------------------------+</span>
01225 <span class="comment">        |  process lock mode             |</span>
01226 <span class="comment">        +-------------------------------*/</span>
01227         <span class="keywordflow">case</span> LL_INFO_LOCKMODE:
01228         {
01229             u_int32 *lockModeP = va_arg(argptr, u_int32*);
01230 
01231             *lockModeP = LL_LOCK_CALL;
01232             <span class="keywordflow">break</span>;
01233         }
01234         <span class="comment">/*-------------------------------+</span>
01235 <span class="comment">        |  (unknown)                     |</span>
01236 <span class="comment">        +-------------------------------*/</span>
01237         <span class="keywordflow">default</span>:
01238             error = ERR_LL_ILL_PARAM;
01239     }
01240 
01241     va_end(argptr);
01242 
01243     <span class="keywordflow">return</span> (error);
01244 }
01245 
01246 <span class="comment">/******************************** Ident ************************************/</span>
<a name="l01251"></a><a class="code" href="z17__drv_8c.html#a24">01251</a> <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z17__drv_8c.html#a24">Ident</a>(<span class="keywordtype">void</span>)
01252 {
01253     <span class="keywordflow">return</span> (<span class="stringliteral">"Z17 - Z17 low level driver: $Id: z17_drv.c,v 1.12 2016/07/13 10:09:33 ts Exp $"</span>
01254 <span class="preprocessor">            #ifdef Z17_MODEL_Z127</span>
01255 <span class="preprocessor"></span>                <span class="stringliteral">" Z127 model"</span>
01256 <span class="preprocessor">            #else</span>
01257 <span class="preprocessor"></span>                <span class="stringliteral">" Z34/Z37 model"</span>
01258 <span class="preprocessor">            #endif</span>
01259 <span class="preprocessor"></span><span class="preprocessor">            #ifdef Z127_NOIRQ</span>
01260 <span class="preprocessor"></span>                <span class="stringliteral">" - no IRQs"</span>
01261 <span class="preprocessor">            #endif</span>
01262 <span class="preprocessor"></span>            );
01263 }
01264 
01265 <span class="comment">/********************************* Cleanup *********************************/</span>
<a name="l01275"></a><a class="code" href="z17__drv_8c.html#a25">01275</a> <span class="keyword">static</span> int32 <a class="code" href="z17__drv_8c.html#a25">Cleanup</a>(
01276     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
01277     int32     retCode
01278 )
01279 {
01280     <span class="comment">/*------------------------------+</span>
01281 <span class="comment">    |  close handles                |</span>
01282 <span class="comment">    +------------------------------*/</span>
01283     <span class="comment">/* clean up desc */</span>
01284     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o3">descHdl</a>)
01285         DESC_Exit(&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o3">descHdl</a>);
01286 
01287     <span class="comment">/* clean up alarm */</span>
01288     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">alarmHdl</a>)
01289         OSS_AlarmRemove(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">alarmHdl</a>);
01290 
01291     <span class="comment">/* clean up debug */</span>
01292     DBGEXIT((&amp;<a class="code" href="z17__drv_8c.html#a6">DBH</a>));
01293 
01294     <span class="comment">/*------------------------------+</span>
01295 <span class="comment">    |  free memory                  |</span>
01296 <span class="comment">    +------------------------------*/</span>
01297     <span class="comment">/* free my handle */</span>
01298     OSS_MemFree(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, (int8*)llHdl, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o0">memAlloc</a>);
01299 
01300     <span class="comment">/*return error code */</span>
01301     <span class="keywordflow">return</span> (retCode);
01302 }
01303 
01304 <span class="comment">/******************************* arwenReset ********************************/</span>
<a name="l01314"></a><a class="code" href="z17__drv_8c.html#a26">01314</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z17__drv_8c.html#a26">arwenReset</a>(
01315     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl
01316 )
01317 {
01318     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>;
01319 
01320     <span class="comment">/* disable all interrupts */</span>
01321     MWRITE_D32(ma, ARWEN_02_IER1, 0);
01322     MWRITE_D32(ma, ARWEN_02_IER2, 0);
01323 
01324     <span class="comment">/* program all ports as inputs */</span>
01325     MWRITE_D32(ma, ARWEN_DDR, 0);
01326 
01327     <span class="comment">/* disable open drain and debouncer */</span>
01328     MWRITE_D32(ma, ARWEN_02_ODER, 0);
01329     MWRITE_D32(ma, ARWEN_02_DBER, 0);
01330 }
01331 
01332 <span class="comment">/******************************* AlarmHandler ******************************/</span>
<a name="l01339"></a><a class="code" href="z17__drv_8c.html#a27">01339</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="z17__drv_8c.html#a27">AlarmHandler</a>(
01340     <span class="keywordtype">void</span> *arg
01341 )
01342 {
01343     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = (<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>*)arg;
01344     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>;
01345 
01346     DBGWRT_3((<a class="code" href="z17__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; LL - Z17_Z127 AlarmHandler:\n"</span>));
01347 
01348     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o23">togCount</a> += <a class="code" href="z17__drv_8c.html#a9">TOG_TIME_MIN</a>;
01349 
01350     <span class="comment">/* reset counter */</span>
01351     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o23">togCount</a> &gt; ((llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o20">togtimeHigh</a> + llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o21">togtimeLow</a>)))
01352         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o23">togCount</a> = 0;
01353 
01354     <span class="comment">/* toggle high */</span>
01355     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o19">togHigh</a> &amp;&amp; (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o23">togCount</a> &lt;= (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o20">togtimeHigh</a>))) {
01356 
01357         <span class="comment">/* lock device */</span>
01358         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o18">devSemHdl</a>)
01359             OSS_SemWait(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o18">devSemHdl</a>, OSS_SEM_WAITFOREVER);
01360 
01361         MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO)
01362                                     | llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a>);
01363 
01364         <span class="comment">/* release device (for other processes) */</span>
01365         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o18">devSemHdl</a>)
01366             OSS_SemSignal(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o18">devSemHdl</a>);
01367 
01368         <span class="comment">/* reset flag */</span>
01369         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o19">togHigh</a> = 0;
01370     }
01371 
01372     <span class="comment">/* toggle low */</span>
01373     <span class="keywordflow">if</span> ((!llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o19">togHigh</a>) &amp;&amp; (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o23">togCount</a> &gt; (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o20">togtimeHigh</a>))) {
01374 
01375         <span class="comment">/* lock device */</span>
01376         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o18">devSemHdl</a>)
01377             OSS_SemWait(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o18">devSemHdl</a>, OSS_SEM_WAITFOREVER);
01378 
01379         MWRITE_D32(ma, ARWEN_GPIO, MREAD_D32(ma, ARWEN_GPIO)
01380                                     &amp; ~(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o22">togBitMask</a>));
01381 
01382         <span class="comment">/* release device (for other processes) */</span>
01383         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o18">devSemHdl</a>)
01384             OSS_SemSignal(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o18">devSemHdl</a>);
01385 
01386         <span class="comment">/* reset flag */</span>
01387         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o19">togHigh</a> = 1;
01388     }
01389 }
01390  
</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for Z17 MDIS Driver using <a href="http://www.doxygen.org">doxygen</a>.<br>
	Copyright &copy; 2016 <a href="http://www.men.de">MEN Mikro Elektronik GmbH</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

